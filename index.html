<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SITYA - Sistem Informasi Tahfizh Yapanza</title>
    <link rel="icon" href="https://i.ibb.co/LzHmvdqc/LOGO-MI-YAPANZA-FIX.png" type="image/png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f0f2f5;
        }
        /* Custom Colors from Logo */
        .sitya-green { background-color: #0A6847; }
        .sitya-gold { background-color: #F3CA52; }
        .text-sitya-green { color: #0A6847; }
        .text-sitya-gold { color: #F3CA52; }
        .border-sitya-green { border-color: #0A6847; }
        .border-sitya-gold { border-color: #F3CA52; }

        /* Marquee Text Animation */
        .marquee {
            width: 100%;
            overflow: hidden;
            white-space: nowrap;
            box-sizing: border-box;
        }
        .marquee span {
            display: inline-block;
            padding-left: 100%;
            animation: marquee 20s linear infinite;
        }
        @keyframes marquee {
            0% { transform: translate(0, 0); }
            100% { transform: translate(-100%, 0); }
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #0A6847;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #085338;
        }

        /* For printable report */
        @page {
            size: A4 landscape;
            margin: 1.5cm;
        }

        @media print {
            body {
                font-size: 10pt;
                overflow: visible !important; /* Perbaikan: Pastikan body tidak memotong */
            }

            /* Perbaikan: Paksa container utama untuk tidak menyembunyikan konten */
            main, .page-content {
                overflow: visible !important;
                display: block !important;
            }

            body * {
                visibility: hidden;
            }
            #print-area, #print-area *, #public-report-area, #public-report-area * {
                visibility: visible;
            }
            #print-area, #public-report-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                padding: 0;
                margin: 0;
            }
            .no-print {
                display: none;
            }
             /* Reset shadows and borders for cleaner print */
            #print-area .shadow-lg, #public-report-area .shadow-lg {
                box-shadow: none !important;
            }
            #print-area .rounded-xl, #public-report-area .rounded-xl {
                border-radius: 0 !important;
            }
             #print-area .border, #public-report-area .border {
                border: 1px solid #ccc !important;
            }
            #print-area th, #print-area td, 
            #public-report-area th, #public-report-area td {
                padding: 4px 8px;
                word-wrap: break-word;
            }
            
            /* NEW RULES TO FIX PAGE BREAKS */
            #print-area .overflow-x-auto {
                overflow-x: visible !important; /* Allow table to use full width */
                border: none !important;
                border-radius: 0 !important;
            }
            #print-area table {
                width: 100%;
                border-collapse: collapse; /* Ensure borders are clean */
            }
            #print-area tr, #print-area td, #print-area th {
                page-break-inside: avoid; /* Try not to break rows across pages */
            }
            .print-header {
                page-break-after: avoid; /* Don't break after the header */
            }
            #laporan-title {
                page-break-after: avoid; /* Don't break after the title */
            }
        }
        
        .modal-backdrop {
            transition: opacity 0.3s ease;
        }
        .modal-content {
            transition: transform 0.3s ease;
        }
        .spinner {
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: #fff;
            border-radius: 50%;
            width: 1rem;
            height: 1rem;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- ===== LOGIN PAGE ===== -->
    <div id="login-page" class="flex items-center justify-center min-h-screen bg-gray-200">
        <div class="w-full max-w-md p-8 space-y-6 bg-white rounded-2xl shadow-lg m-4">
            <div class="text-center">
                <img src="https://i.ibb.co/LzHmvdqc/LOGO-MI-YAPANZA-FIX.png" alt="Logo Yapanza" class="w-24 h-24 mx-auto mb-4">
                <h2 class="text-3xl font-bold text-sitya-green">SITYA</h2>
                <p class="text-gray-500">Sistem Informasi Tahfizh Yapanza</p>
            </div>
            
            <!-- Student Report Search -->
            <div class="pt-4 space-y-4 border-t">
                 <h3 class="text-center text-lg font-medium text-gray-700">Lihat Riwayat Penilaian Siswa</h3>
                 <form id="student-report-form">
                    <div>
                        <label for="public-student-search-input" class="text-sm font-medium text-gray-700">Nama Siswa</label>
                         <div class="relative">
                            <input type="text" id="public-student-search-input" placeholder="Ketik nama untuk mencari..." class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-sitya-green focus:border-sitya-green block w-full p-2.5 mt-1" autocomplete="off">
                            <div id="public-student-options-container" class="absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg hidden max-h-48 overflow-y-auto">
                                <!-- Opsi siswa akan diisi oleh JavaScript -->
                            </div>
                        </div>
                    </div>
                    <p id="student-report-error" class="text-sm text-red-600 text-center hidden">Silakan pilih siswa dari daftar.</p>
                    <button type="submit" class="w-full mt-4 flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white sitya-green hover:bg-opacity-90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-sitya-green transition duration-150">
                        <i class="fas fa-search mr-2"></i> Lihat Laporan
                    </button>
                 </form>
            </div>

            <!-- Staff Login Button -->
            <div class="mt-6 text-center">
                <button id="open-staff-login-button" class="text-sm text-sitya-green hover:underline">Login Staff</button>
            </div>
            
            <div class="marquee sitya-green text-white py-2 rounded-md mt-6">
                <span>"Sebaik-baik kalian adalah orang yang belajar Al-Qur'an dan mengajarkannya." (HR. Bukhari) --- Selamat Datang di Sistem Informasi Tahfizh Yapanza (SITYA) ---</span>
            </div>
        </div>
    </div>
    
    <!-- ===== STUDENT REPORT PAGE ===== -->
    <div id="student-report-page" class="hidden min-h-screen bg-gray-100 p-4 sm:p-8 no-print">
        <div class="max-w-5xl mx-auto bg-white p-4 sm:p-8 rounded-xl shadow-lg">
            <header class="flex justify-between items-center mb-6 pb-4 border-b">
                 <div class="flex items-center">
                    <img src="https://i.ibb.co/LzHmvdqc/LOGO-MI-YAPANZA-FIX.png" alt="Logo Yapanza" class="w-16 h-16 mr-4">
                    <div>
                        <h2 class="text-2xl font-bold text-sitya-green">Riwayat Penilaian Siswa</h2>
                        <p id="public-report-title" class="text-gray-600"></p>
                    </div>
                </div>
                <button id="back-to-login-button" class="sitya-green text-white px-4 py-2 rounded-lg hover:bg-opacity-90"><i class="fas fa-arrow-left mr-2"></i>Kembali</button>
            </header>
            <!-- MODIFIED: Informational Text Added Here -->
<p class="text-sm italic text-gray-600 mb-4 p-3 bg-yellow-50 border-l-4 border-yellow-500 rounded-md">
    ⚠️ Perhatian: Hanya menampilkan riwayat <strong>3 hari terakhir</strong>. Untuk melihat laporan penilaian yang lebih lama atau keseluruhan, silakan hubungi Pembimbing anak anda.
</p>
            <div id="public-report-area"> 
                 <div class="overflow-x-auto border rounded-lg">
                    <table class="w-full text-left">
                         <thead id="public-report-table-head" class="bg-gray-100">
                             <!-- Header dinamis akan diisi di sini -->
                        </thead>
                        <tbody id="public-report-table-body">
                             <!-- Body dinamis akan diisi di sini -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>


    <!-- ===== MAIN APP ===== -->
    <div id="main-app" class="hidden">
        <div class="relative min-h-screen md:flex overflow-x-hidden">
            <!-- Mobile Menu Overlay -->
            <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden md:hidden"></div>
            
            <!-- Sidebar -->
            <aside id="sidebar" class="no-print bg-gray-800 text-white w-64 space-y-6 py-7 px-2 absolute inset-y-0 left-0 transform -translate-x-full md:relative md:translate-x-0 transition-transform duration-300 ease-out z-40 flex flex-col">
                <div class="h-20 flex items-center justify-center border-b border-gray-600 flex-shrink-0 px-4">
                    <img src="https://i.ibb.co/LzHmvdqc/LOGO-MI-YAPANZA-FIX.png" alt="Logo Yapanza" class="w-12 h-12">
                    <span class="ml-3 text-2xl font-bold">SITYA</span>
                </div>
                <nav class="flex-1 px-4 space-y-2">
                    <a href="#dashboard" class="nav-link flex items-center px-4 py-2.5 rounded-lg bg-gray-700">
                        <i class="fas fa-home w-6"></i> <span>Dashboard</span>
                    </a>
                    <a href="#siswa" data-role="admin" class="nav-link flex items-center px-4 py-2.5 rounded-lg hover:bg-gray-700">
                        <i class="fas fa-user-graduate w-6"></i> <span>Kelola Siswa</span>
                    </a>
                    <a href="#pengajar" data-role="admin" class="nav-link flex items-center px-4 py-2.5 rounded-lg hover:bg-gray-700">
                        <i class="fas fa-chalkboard-teacher w-6"></i> <span>Kelola Pengajar</span>
                    </a>
                    <a href="#kelas" data-role="admin" class="nav-link flex items-center px-4 py-2.5 rounded-lg hover:bg-gray-700">
                        <i class="fas fa-school w-6"></i> <span>Kelola Kelas</span>
                    </a>
                    <a href="#penilaian" class="nav-link flex items-center px-4 py-2.5 rounded-lg hover:bg-gray-700">
                        <i class="fas fa-edit w-6"></i> <span>Input Penilaian</span>
                    </a>
                    <a href="#riwayat-guru" data-role="guru" class="nav-link flex items-center px-4 py-2.5 rounded-lg hover:bg-gray-700 hidden">
                        <i class="fas fa-history w-6"></i> <span>Riwayat Siswa</span>
                    </a>
                    <a href="#laporan" class="nav-link flex items-center px-4 py-2.5 rounded-lg hover:bg-gray-700">
                        <i class="fas fa-print w-6"></i> <span>Laporan Penilaian</span>
                    </a>
                    <a href="#pengguna" data-role="admin" class="nav-link flex items-center px-4 py-2.5 rounded-lg hover:bg-gray-700">
                        <i class="fas fa-users-cog w-6"></i> <span>Kelola Pengguna</span>
                    </a>
                </nav>
                <!-- Tombol logout-button dipindahkan ke header -->
            </aside>
            
            <!-- Main Content -->
            <main class="flex-1 flex flex-col overflow-hidden transition-transform duration-300 ease-out md:translate-x-0">
                <header class="no-print bg-white shadow-md flex items-center justify-between px-4 sm:px-6 h-20">
                    <div class="flex items-center">
                        <!-- Mobile Sidebar Toggle -->
                        <button id="sidebar-toggle" class="no-print md:hidden text-gray-500 focus:outline-none focus:text-gray-700 mr-4">
                            <span class="sr-only">Buka menu</span>
                            <i id="menu-open-icon" class="fas fa-bars fa-lg"></i>
                            <i id="menu-close-icon" class="fas fa-times fa-lg hidden"></i>
                        </button>
                        <h1 id="page-title" class="text-xl md:text-2xl font-semibold text-gray-700">Dashboard</h1>
                    </div>
                    <div class="relative">
                        <button id="avatar-button" class="flex items-center focus:outline-none">
                            <span id="welcome-message" class="mr-2 sm:mr-4 text-gray-600 hidden sm:block">Selamat datang, !</span>
                            <img id="user-avatar" class="w-10 h-10 rounded-full object-cover" src="https://placehold.co/100x100/0A6847/FFFFFF?text=A" alt="Avatar">
                        </button>
                        
                        <!-- Dropdown Menu -->
                        <div id="user-dropdown" class="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-50 hidden">
                            <a href="#" id="logout-button" class="block px-4 py-2 text-sm text-red-600 hover:bg-gray-100">
                                <i class="fas fa-sign-out-alt w-6 mr-2"></i>Logout
                            </a>
                        </div>
                    </div>
                </header>

                <div class="flex-1 p-4 md:p-6 overflow-y-auto">
                    
                    <!-- ===== CONTENT PAGES ===== -->

                    <!-- Dashboard Content -->
                    <div id="dashboard" class="page-content">
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                            <!-- Kartu Statistik Siswa Bimbingan (Hanya untuk Guru) -->
                            <div class="bg-white p-6 rounded-xl shadow-lg flex items-center hidden" data-role="guru">
                                <div class="p-4 rounded-full sitya-green text-white mr-4"><i class="fas fa-users fa-2x"></i></div>
                                <div>
                                    <p class="text-gray-500">Siswa Bimbingan</p>
                                    <p class="text-3xl font-bold text-gray-800" id="total-siswa-bimbingan">0</p>
                                </div>
                            </div>
                            
                            <!-- Kartu Statistik Admin -->
                            <div class="bg-white p-6 rounded-xl shadow-lg flex items-center" data-role="admin">
                                <div class="p-4 rounded-full sitya-green text-white mr-4"><i class="fas fa-user-graduate fa-2x"></i></div>
                                <div>
                                    <p class="text-gray-500">Total Siswa</p>
                                    <p class="text-3xl font-bold text-gray-800" id="total-siswa">0</p>
                                </div>
                            </div>
                             <div class="bg-white p-6 rounded-xl shadow-lg flex items-center" data-role="admin">
                                <div class="p-4 rounded-full sitya-green text-white mr-4"><i class="fas fa-chalkboard-teacher fa-2x"></i></div>
                                <div>
                                    <p class="text-gray-500">Total Pengajar</p>
                                    <p class="text-3xl font-bold text-gray-800" id="total-pengajar">0</p>
                                </div>
                            </div>
                             <div class="bg-white p-6 rounded-xl shadow-lg flex items-center" data-role="admin">
                                <div class="p-4 rounded-full sitya-green text-white mr-4"><i class="fas fa-school fa-2x"></i></div>
                                <div>
                                    <p class="text-gray-500">Total Kelas</p>
                                    <p class="text-3xl font-bold text-gray-800" id="total-kelas">0</p>
                                </div>
                            </div>
                            
                            <!-- Kartu Statistik Umum (Semua Role) -->
                            <div class="bg-white p-6 rounded-xl shadow-lg flex items-center">
                                <div class="p-4 rounded-full sitya-green text-white mr-4"><i class="fas fa-book-open fa-2x"></i></div>
                                <div>
                                    <p class="text-gray-500">Penilaian Hari Ini</p>
                                    <p class="text-3xl font-bold text-gray-800" id="total-penilaian-hari-ini">0</p>
                                </div>
                            </div>
                        </div>

                        <!-- NEW: Tabel Siswa Bimbingan (Hanya Guru) -->
                        <div class="mt-8 hidden" data-role="guru">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-xl font-semibold text-gray-700">Siswa Bimbingan Anda</h3>
                                <input type="text" id="guru-search-siswa-input" placeholder="Cari siswa bimbingan..." class="bg-white border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-sitya-green focus:border-sitya-green block w-full sm:w-1/3 p-2.5">
                            </div>
                            <div class="bg-white p-4 sm:p-6 rounded-xl shadow-lg">
                                <div class="overflow-x-auto">
                                    <table class="w-full text-left" id="guru-siswa-table">
                                        <thead class="bg-gray-100">
                                            <tr>
                                                <th class="p-3">No</th>
                                                <th class="p-3">NISN</th>
                                                <th class="p-3">Nama</th>
                                                <th class="p-3">Kelas</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <!-- Data siswa bimbingan guru -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Siswa Content -->
                    <div id="siswa" class="page-content hidden">
                        <div class="bg-white p-4 sm:p-6 rounded-xl shadow-lg">
                            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4">
                                <h2 class="text-xl font-semibold mb-2 sm:mb-0">Data Siswa</h2>
                                <div class="flex flex-col sm:flex-row gap-2 w-full sm:w-auto">
                                    <input type="text" id="admin-search-siswa-input" placeholder="Cari siswa..." class="bg-white border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-sitya-green focus:border-sitya-green block w-full sm:w-auto p-2.5">
                                    <button onclick="openAddSiswaModal()" class="sitya-green text-white px-4 py-2 rounded-lg hover:bg-opacity-90 w-full sm:w-auto"><i class="fas fa-plus mr-2"></i>Tambah Siswa</button>
                                </div>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full text-left" id="siswa-table">
                                    <thead class="bg-gray-100">
                                        <tr>
                                            <th class="p-3">No</th>
                                            <th class="p-3">NISN</th>
                                            <th class="p-3">Nama</th>
                                            <th class="p-3">Kelas</th>
                                            <th class="p-3">Pembimbing</th>
                                            <th class="p-3">Aksi</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Data Siswa akan dirender di sini oleh JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                            <div id="pagination-container" class="flex justify-center items-center mt-4">
                                <!-- Pagination buttons will be rendered here -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Penilaian Content -->
                    <div id="penilaian" class="page-content hidden">
                        <div class="bg-white p-4 sm:p-6 rounded-xl shadow-lg">
                            <h2 class="text-xl font-semibold mb-4">Input Penilaian Tahfizh</h2>
                             <form id="penilaian-form">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                                    <div>
                                        <label for="search-siswa-input" class="block mb-2 text-sm font-medium text-gray-900">Pilih Siswa (Ketik untuk mencari)</label>
                                        <div class="relative">
                                            <input type="text" id="search-siswa-input" placeholder="Cari nama siswa..." class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-sitya-green focus:border-sitya-green block w-full p-2.5" autocomplete="off" required>
                                            <div id="siswa-options-container" class="absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg hidden max-h-60 overflow-y-auto">
                                                <!-- Opsi siswa akan diisi oleh JavaScript -->
                                            </div>
                                        </div>
                                    </div>
                                    <div>
                                        <label for="jenis-penilaian" class="block mb-2 text-sm font-medium text-gray-900">Jenis Penilaian</label>
                                        <select id="jenis-penilaian" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-sitya-green focus:border-sitya-green block w-full p-2.5" required>
                                          <option value="">Pilih jenis...</option>
                                          <option value="Iqro">Iqro</option>
                                          <option value="Hafalan Baru">Hafalan Baru</option>
                                          <option value="Muroja'ah">Muroja'ah</option>
                                          <option value="Mengaji">Mengaji</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <!-- Riwayat Terakhir -->
                                <div id="riwayat-terakhir-container" class="hidden mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                                    <h4 class="font-semibold text-gray-700 mb-2">Riwayat Penilaian Terakhir</h4>
                                    <p id="riwayat-terakhir-content" class="text-gray-600 text-sm leading-relaxed"></p>
                                </div>

                                <!-- Dynamic Form Fields -->
                                <div id="form-penilaian-container" class="hidden space-y-4 pt-4 border-t">
                                    <!-- Iqro Specific Fields -->
                                    <div id="iqro-fields" class="hidden space-y-4">
                                         <div>
                                            <label class="block text-sm font-medium text-gray-700">Jilid</label>
                                            <input type="number" id="iqro-jilid" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-sitya-green focus:ring-sitya-green sm:text-sm" placeholder="Contoh: 4">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">Halaman</label>
                                            <input type="number" id="iqro-halaman" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-sitya-green focus:ring-sitya-green sm:text-sm" placeholder="Contoh: 15">
                                        </div>
                                        <div class="grid grid-cols-2 gap-4">
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700">Baris dari</label>
                                                <input type="number" id="iqro-baris-dari" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-sitya-green focus:ring-sitya-green sm:text-sm" placeholder="Awal">
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700">Sampai</label>
                                                <input type="number" id="iqro-baris-sampai" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-sitya-green focus:ring-sitya-green sm:text-sm" placeholder="Akhir">
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Surat/Ayat Specific Fields -->
                                    <div id="surat-ayat-fields" class="hidden space-y-4">
                                        <div class="relative">
                                            <label class="block text-sm font-medium text-gray-700">Surat</label>
                                            <input type="text" id="surat-ayat-surat" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-sitya-green focus:ring-sitya-green sm:text-sm" placeholder="Ketik nama surat..." autocomplete="off">
                                             <div id="surat-options-container" class="absolute z-20 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg hidden max-h-48 overflow-y-auto"></div>
                                        </div>
                                        <div class="grid grid-cols-2 gap-4">
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700">Ayat dari</label>
                                                <input type="number" id="surat-ayat-dari" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-sitya-green focus:ring-sitya-green sm:text-sm" placeholder="Awal">
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700">Sampai</label>
                                                <input type="number" id="surat-ayat-sampai" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-sitya-green focus:ring-sitya-green sm:text-sm" placeholder="Akhir">
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Common Fields -->
                                    <div id="common-fields" class="space-y-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">Penilaian</label>
                                            <select id="common-hasil" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-sitya-green focus:ring-sitya-green sm:text-sm" required>
                                                <option value="">Pilih hasil penilaian...</option>
                                                <option>Lancar/Pindah</option>
                                                <option>Kurang Lancar/Ulang</option>
                                                <option>Mengulang</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">Dinilai oleh</label>
                                            <select id="dinilai-oleh" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-sitya-green focus:ring-sitya-green sm:text-sm disabled:bg-gray-200" required>
                                                <!-- Options populated by JS -->
                                            </select>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">Catatan (Opsional)</label>
                                            <textarea id="common-catatan" rows="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-sitya-green focus:ring-sitya-green sm:text-sm" placeholder="Tulis catatan untuk siswa..."></textarea>
                                        </div>
                                    </div>
                                     <div class="flex justify-end">
                                        <button id="simpan-penilaian-button" type="submit" class="sitya-green text-white px-6 py-2 rounded-lg hover:bg-opacity-90 flex items-center justify-center disabled:opacity-75">
                                            <i class="fas fa-save mr-2"></i>
                                            <span>Simpan Penilaian</span>
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- NEW: Riwayat Guru Content -->
                    <div id="riwayat-guru" class="page-content hidden" data-role="guru">
                        <div class="bg-white p-4 sm:p-6 rounded-xl shadow-lg">
                            <h2 class="text-xl font-semibold mb-4">Riwayat Penilaian Siswa Bimbingan</h2>
                            <div class="mb-4">
                                <label for="riwayat-jenis-penilaian" class="block mb-2 text-sm font-medium text-gray-900">Pilih Jenis Penilaian:</label>
                                <select id="riwayat-jenis-penilaian" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-sitya-green focus:border-sitya-green block w-full md:w-1/3 p-2.5">
                                    <option value="">Pilih jenis...</option>
                                    <option value="Iqro">Iqro</option>
                                    <option value="Hafalan Baru">Hafalan Baru</option>
                                    <option value="Muroja'ah">Muroja'ah</option>
                                    <option value="Mengaji">Mengaji</option>
                                </select>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full text-left" id="riwayat-guru-table">
                                    <thead class="bg-gray-100">
                                        <tr>
                                            <th class="p-3">No</th>
                                            <th class="p-3">Nama Siswa</th>
                                            <th class="p-3">Detail Terakhir</th>
                                            <th class="p-3">Hasil</th>
                                            <th class="p-3">Catatan</th>
                                            <th class="p-3">Dinilai oleh</th>
                                            <th class="p-3">Tanggal</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Data akan diisi oleh JS -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Laporan Content -->
                    <div id="laporan" class="page-content hidden">
                        <div class="bg-white p-4 sm:p-6 rounded-xl shadow-lg">
                            <h2 class="text-xl font-semibold mb-4">Rekap Laporan Penilaian</h2>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-6 p-4 bg-gray-50 rounded-lg items-end">
                                 <div>
                                    <label for="laporan-pilih-kelas" class="block mb-2 text-sm font-medium text-gray-900">Kelas Tahfizh</label>
                                    <select id="laporan-pilih-kelas" class="bg-white border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-sitya-green focus:border-sitya-green block w-full p-2.5">
                                      <!-- Opsi diisi oleh JS -->
                                    </select>
                                </div>
                                <div class="lg:col-span-2">
                                    <label for="laporan-search-siswa-input" class="block mb-2 text-sm font-medium text-gray-900">Pilih Siswa</label>
                                    <div class="relative">
                                        <input type="text" id="laporan-search-siswa-input" placeholder="Cari nama atau pilih dari daftar" class="bg-white border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-sitya-green focus:border-sitya-green block w-full p-2.5" autocomplete="off">
                                        <div id="laporan-siswa-options-container" class="absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg hidden max-h-60 overflow-y-auto">
                                            <!-- Opsi siswa akan diisi oleh JavaScript -->
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <label for="laporan-tanggal-dari" class="block mb-2 text-sm font-medium text-gray-900">Dari Tanggal</label>
                                    <input type="date" id="laporan-tanggal-dari" class="bg-white border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-sitya-green focus:border-sitya-green block w-full p-2.5">
                                </div>
                                 <div>
                                    <label for="laporan-tanggal-sampai" class="block mb-2 text-sm font-medium text-gray-900">Sampai Tanggal</label>
                                    <input type="date" id="laporan-tanggal-sampai" class="bg-white border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-sitya-green focus:border-sitya-green block w-full p-2.5">
                                </div>
                                <div class="lg:col-span-5 flex justify-end">
                                    <button onclick="filterLaporan()" class="w-full lg:w-auto sitya-green text-white px-4 py-2.5 rounded-lg hover:bg-opacity-90">Tampilkan Laporan</button>
                                </div>
                            </div>
                            
                            <!-- Area Laporan untuk di-print -->
                            <div id="laporan-hasil-container" class="hidden">
                                <div id="print-area">
                                    <div class="text-center mb-8 hidden print-header">
                                        <img src="https://i.ibb.co/LzHmvdqc/LOGO-MI-YAPANZA-FIX.png" alt="Logo Yapanza" class="w-20 h-20 mx-auto">
                                        <h3 class="text-xl font-bold mt-2 text-sitya-green">Laporan Penilaian Tahfizh</h3>
                                        <p id="print-info-siswa" class="text-gray-600"></p>
                                        <p id="print-info-periode" class="text-gray-500"></p>
                                    </div>

                                    <h3 id="laporan-title" class="font-semibold text-lg mb-2"></h3>
                                    <div class="overflow-x-auto border rounded-lg">
                                        <table class="w-full text-left">
                                             <thead id="laporan-table-head" class="bg-gray-100">
                                                <!-- Header dinamis akan diisi di sini -->
                                            </thead>
                                            <tbody id="laporan-table-body">
                                                <!-- Body dinamis akan diisi di sini -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                
                                <div id="laporan-pagination-container" class="flex justify-center items-center mt-4">
                                    <!-- Pagination buttons will be rendered here -->
                                </div>

                                 <div class="flex justify-end mt-6">
                                    <button onclick="printReport()" class="bg-red-600 text-white px-6 py-2 rounded-lg hover:bg-red-700"><i class="fas fa-print mr-2"></i>Cetak Laporan</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Pengajar Content -->
                     <div id="pengajar" class="page-content hidden">
                        <div class="bg-white p-4 sm:p-6 rounded-xl shadow-lg">
                            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4">
                                <h2 class="text-xl font-semibold mb-2 sm:mb-0">Data Pengajar</h2>
                                <button onclick="openAddPengajarModal()" class="sitya-green text-white px-4 py-2 rounded-lg hover:bg-opacity-90 w-full sm:w-auto"><i class="fas fa-plus mr-2"></i>Tambah Pengajar</button>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full text-left" id="pengajar-table">
                                    <thead class="bg-gray-100">
                                        <tr>
                                            <th class="p-3">No</th>
                                            <th class="p-3">Nama</th>
                                            <th class="p-3">Aksi</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Data Pengajar akan dirender di sini oleh JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                     <div id="kelas" class="page-content hidden">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Kelas Reguler Card -->
                            <div class="bg-white p-4 sm:p-6 rounded-xl shadow-lg">
                                <div class="flex justify-between items-center mb-4">
                                    <h2 class="text-xl font-semibold">Data Kelas Reguler</h2>
                                    <button onclick="openAddKelasModal('reguler')" class="sitya-green text-white px-4 py-2 rounded-lg hover:bg-opacity-90"><i class="fas fa-plus mr-2"></i>Tambah</button>
                                </div>
                                <div class="overflow-x-auto">
                                    <table class="w-full text-left" id="kelas-reguler-table">
                                        <thead class="bg-gray-100">
                                            <tr>
                                                <th class="p-3">Nama Kelas</th>
                                                <th class="p-3">Aksi</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                           <!-- Data Kelas Reguler akan dirender di sini -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                             <!-- Kelas Tahfizh Card -->
                            <div class="bg-white p-4 sm:p-6 rounded-xl shadow-lg">
                                <div class="flex justify-between items-center mb-4">
                                    <h2 class="text-xl font-semibold">Data Kelas Tahfizh</h2>
                                     <button onclick="openAddKelasModal('tahfizh')" class="sitya-green text-white px-4 py-2 rounded-lg hover:bg-opacity-90"><i class="fas fa-plus mr-2"></i>Tambah</button>
                                </div>
                                 <div class="overflow-x-auto">
                                    <table class="w-full text-left" id="kelas-tahfizh-table">
                                        <thead class="bg-gray-100">
                                            <tr>
                                                <th class="p-3">Nama Kelas</th>
                                                <th class="p-3">Aksi</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <!-- Data Kelas Tahfizh akan dirender di sini -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                     <div id="pengguna" class="page-content hidden">
                        <div class="bg-white p-4 sm:p-6 rounded-xl shadow-lg">
                            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4">
                                <h2 class="text-xl font-semibold mb-2 sm:mb-0">Data Pengguna</h2>
                                <button onclick="openAddPenggunaModal()" class="sitya-green text-white px-4 py-2 rounded-lg hover:bg-opacity-90 w-full sm:w-auto"><i class="fas fa-plus mr-2"></i>Tambah Pengguna</button>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full text-left" id="pengguna-table">
                                    <thead class="bg-gray-100">
                                        <tr>
                                            <th class="p-3">No</th>
                                            <th class="p-3">Username</th>
                                            <th class="p-3">Nama</th>
                                            <th class="p-3">Role</th>
                                            <th class="p-3">Aksi</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Data Pengguna akan dirender di sini -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                </div>
            </main>
        </div>
    </div>

    <!-- ===== MODALS ===== -->
    
    <!-- Staff Login Modal -->
    <div id="staffLoginModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 hidden modal-backdrop">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm modal-content transform scale-95">
             <div class="p-6 border-b flex justify-between items-center">
                <h3 class="text-xl font-semibold text-gray-800">Login Staff</h3>
                <button onclick="closeModal('staffLoginModal')" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
            </div>
            <form id="login-form-modal" class="space-y-6 p-6">
                <div>
                    <label for="username-modal" class="text-sm font-medium text-gray-700">Username</label>
                    <input id="username-modal" name="username" type="text" required class="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md shadow-sm focus:ring-sitya-green focus:border-sitya-green" placeholder="Masukkan username">
                </div>
                <div>
                    <label for="password-modal" class="text-sm font-medium text-gray-700">Password</label>
                    <input id="password-modal" name="password" type="password" required class="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md shadow-sm focus:ring-sitya-green focus:border-sitya-green" placeholder="Masukkan password">
                </div>
                <p id="login-error-modal" class="text-sm text-red-600 text-center hidden">Username atau password salah.</p>
                <div>
                    <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white sitya-green hover:bg-opacity-90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-sitya-green transition duration-150">
                        Masuk
                    </button>
                </div>
            </form>
        </div>
    </div>


    <!-- Add/Edit Siswa Modal -->
    <div id="siswaModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 hidden modal-backdrop">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md modal-content transform scale-95">
            <div class="p-6 border-b">
                <h3 class="text-xl font-semibold text-gray-800" id="siswaModalTitle">Tambah Siswa Baru</h3>
            </div>
            <form id="siswaForm">
                <div class="p-6 space-y-4">
                    <input type="hidden" id="editSiswaId">
                    <div>
                        <label for="nisn" class="text-sm font-medium text-gray-700">NISN</label>
                        <input id="nisn" type="number" required class="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md shadow-sm focus:ring-sitya-green focus:border-sitya-green">
                    </div>
                    <div>
                        <label for="nama" class="text-sm font-medium text-gray-700">Nama</label>
                        <input id="nama" type="text" required class="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md shadow-sm focus:ring-sitya-green focus:border-sitya-green">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="kelasReguler" class="text-sm font-medium text-gray-700">Kelas Reguler</label>
                            <select id="kelasReguler" required class="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md shadow-sm focus:ring-sitya-green focus:border-sitya-green">
                                <!-- Opsi Kelas Reguler akan diisi oleh JavaScript -->
                            </select>
                        </div>
                         <div>
                            <label for="kelasTahfizh" class="text-sm font-medium text-gray-700">Kelas Tahfizh</label>
                            <select id="kelasTahfizh" required class="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md shadow-sm focus:ring-sitya-green focus:border-sitya-green">
                                <!-- Opsi Kelas Tahfizh akan diisi oleh JavaScript -->
                            </select>
                        </div>
                    </div>
                     <div>
                        <label for="pembimbing" class="text-sm font-medium text-gray-700">Pembimbing</label>
                        <select id="pembimbing" required class="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md shadow-sm focus:ring-sitya-green focus:border-sitya-green">
                           <!-- Opsi Pengajar akan diisi oleh JavaScript -->
                        </select>
                    </div>
                    <p id="siswa-form-error" class="text-sm text-red-600 text-center hidden"></p>
                </div>
                <div class="px-6 py-4 bg-gray-50 flex justify-end space-x-3 rounded-b-lg">
                    <button type="button" onclick="closeModal('siswaModal')" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Batal</button>
                    <button type="submit" class="px-4 py-2 sitya-green text-white rounded-md hover:bg-opacity-90">Simpan</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- View Siswa Modal -->
    <div id="viewSiswaModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 hidden modal-backdrop">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md modal-content transform scale-95">
             <div class="p-6 border-b flex justify-between items-center">
                <h3 class="text-xl font-semibold text-gray-800">Detail Siswa</h3>
                <button onclick="closeModal('viewSiswaModal')" class="text-gray-500 hover:text-gray-800">&times;</button>
            </div>
            <div class="p-6 space-y-2">
                <p><strong>NISN:</strong> <span id="viewNisn"></span></p>
                <p><strong>Nama:</strong> <span id="viewNama"></span></p>
                <p><strong>Kelas:</strong> <span id="viewKelasSiswa"></span></p>
                <p><strong>Pembimbing:</strong> <span id="viewPembimbing"></span></p>
            </div>
             <div class="px-6 py-4 bg-gray-50 flex justify-end rounded-b-lg">
                <button type="button" onclick="closeModal('viewSiswaModal')" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Tutup</button>
            </div>
        </div>
    </div>

    <!-- Add/Edit Pengajar Modal -->
    <div id="pengajarModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 hidden modal-backdrop">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md modal-content transform scale-95">
            <div class="p-6 border-b">
                <h3 class="text-xl font-semibold text-gray-800" id="pengajarModalTitle">Tambah Pengajar Baru</h3>
            </div>
            <form id="pengajarForm">
                <div class="p-6 space-y-4">
                    <input type="hidden" id="editPengajarId">
                    <div>
                        <label for="namaPengajar" class="text-sm font-medium text-gray-700">Nama Pengajar</label>
                        <input id="namaPengajar" type="text" required class="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md shadow-sm focus:ring-sitya-green focus:border-sitya-green">
                    </div>
                </div>
                <div class="px-6 py-4 bg-gray-50 flex justify-end space-x-3 rounded-b-lg">
                    <button type="button" onclick="closeModal('pengajarModal')" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Batal</button>
                    <button type="submit" class="px-4 py-2 sitya-green text-white rounded-md hover:bg-opacity-90">Simpan</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Add/Edit Kelas Modal -->
    <div id="kelasModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 hidden modal-backdrop">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md modal-content transform scale-95">
            <div class="p-6 border-b">
                <h3 class="text-xl font-semibold text-gray-800" id="kelasModalTitle">Tambah Kelas Baru</h3>
            </div>
            <form id="kelasForm">
                <div class="p-6 space-y-4">
                    <input type="hidden" id="editKelasId">
                    <input type="hidden" id="kelasType">
                    <div>
                        <label for="namaKelas" class="text-sm font-medium text-gray-700">Nama Kelas</label>
                        <input id="namaKelas" type="text" required class="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md shadow-sm focus:ring-sitya-green focus:border-sitya-green">
                    </div>
                </div>
                <div class="px-6 py-4 bg-gray-50 flex justify-end space-x-3 rounded-b-lg">
                    <button type="button" onclick="closeModal('kelasModal')" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Batal</button>
                    <button type="submit" class="px-4 py-2 sitya-green text-white rounded-md hover:bg-opacity-90">Simpan</button>
                </div>
            </form>
        </div>
    </div>

     <!-- Add/Edit Pengguna Modal -->
    <div id="penggunaModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 hidden modal-backdrop">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md modal-content transform scale-95">
            <div class="p-6 border-b">
                <h3 class="text-xl font-semibold text-gray-800" id="penggunaModalTitle">Tambah Pengguna Baru</h3>
            </div>
            <form id="penggunaForm">
                <div class="p-6 space-y-4">
                    <input type="hidden" id="editPenggunaId">
                    <div>
                        <label for="namaPengguna" class="text-sm font-medium text-gray-700">Nama Guru</label>
                        <select id="namaPengguna" required class="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md shadow-sm focus:ring-sitya-green focus:border-sitya-green">
                           <!-- Options populated by JS -->
                        </select>
                    </div>
                    <div>
                        <label for="usernamePengguna" class="text-sm font-medium text-gray-700">Username</label>
                        <input id="usernamePengguna" type="text" required class="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md shadow-sm focus:ring-sitya-green focus:border-sitya-green disabled:bg-gray-200">
                    </div>
                    <div>
                        <label for="passwordPengguna" class="text-sm font-medium text-gray-700">Password</label>
                        <input id="passwordPengguna" type="password" required class="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md shadow-sm focus:ring-sitya-green focus:border-sitya-green">
                    </div>
                    <div>
                        <label for="rolePengguna" class="text-sm font-medium text-gray-700">Role</label>
                        <select id="rolePengguna" required class="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md shadow-sm focus:ring-sitya-green focus:border-sitya-green disabled:bg-gray-200">
                           <option value="Admin">Admin</option>
                           <option value="Guru">Guru</option>
                        </select>
                    </div>
                </div>
                <div class="px-6 py-4 bg-gray-50 flex justify-end space-x-3 rounded-b-lg">
                    <button type="button" onclick="closeModal('penggunaModal')" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Batal</button>
                    <button type="submit" class="px-4 py-2 sitya-green text-white rounded-md hover:bg-opacity-90">Simpan</button>
                </div>
            </form>
        </div>
    </div>


<script type="module">
    // --- SUPABASE CLIENT SETUP ---
    const SUPABASE_URL = 'https://ipzsytmlbdnlwtdxbfgx.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlwenN5dG1sYmRubHd0ZHhiZmd4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMTcwNjQsImV4cCI6MjA3MzU5MzA2NH0.3dd66rBy4uCL6w7x2C-Mp3I-V82OGlb2cLLPH-zPlfs';
    const { createClient } = supabase;
    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // --- GLOBAL STATE ---
    let siswaData = [];
    let pengajarData = [];
    let kelasRegulerData = [];
    let kelasTahfizhData = [];
    let penilaianData = [];
    let userData = [];
    let currentUser = null; // Made global for easier access
    let currentPage = 1;
    let laporanCurrentPage = 1; // Halaman untuk laporan
    const rowsPerPage = 10;
    
    const daftarSurat = [
        "Al-Fatihah", "Al-Baqarah", "Ali 'Imran", "An-Nisa'", "Al-Ma'idah", "Al-An'am", "Al-A'raf", "Al-Anfal", "At-Tawbah",
        "Yunus", "Hud", "Yusuf", "Ar-Ra'd", "Ibrahim", "Al-Hijr", "An-Nahl", "Al-Isra'", "Al-Kahf", "Maryam", "Taha",
        "Al-Anbiya'", "Al-Hajj", "Al-Mu'minun", "An-Nur", "Al-Furqan", "Asy-Syu'ara'", "An-Naml", "Al-Qasas", "Al-'Ankabut",
        "Ar-Rum", "Luqman", "As-Sajdah", "Al-Ahzab", "Saba'", "Fatir", "Ya-Sin", "As-Saffat", "Sad", "Az-Zumar", "Ghafir",
        "Fussilat", "Asy-Syura", "Az-Zukhruf", "Ad-Dukhan", "Al-Jasiyah", "Al-Ahqaf", "Muhammad", "Al-Fath", "Al-Hujurat",
        "Qaf", "Az-Zariyat", "At-Tur", "An-Najm", "Al-Qamar", "Ar-Rahman", "Al-Waqi'ah", "Al-Hadid", "Al-Mujadilah", "Al-Hasyr",
        "Al-Mumtahanah", "As-Saff", "Al-Jumu'ah", "Al-Munafiqun", "At-Tagabun", "At-Talaq", "At-Tahrim", "Al-Mulk", "Al-Qalam",
        "Al-Haqqah", "Al-Ma'arij", "Nuh", "Al-Jinn", "Al-Muzzammil", "Al-Muddassir", "Al-Qiyamah", "Al-Insan", "Al-Mursalat",
        "An-Naba'", "An-Nazi'at", "'Abasa", "At-Takwir", "Al-Infitar", "Al-Mutaffifin", "Al-Insyiqaq", "Al-Buruj", "At-Tariq",
        "Al-A'la", "Al-Gasyiyah", "Al-Fajr", "Al-Balad", "Asy-Syams", "Al-Lail", "Ad-Duha", "Asy-Syarh", "At-Tin", "Al-'Alaq",
        "Al-Qadr", "Al-Bayyinah", "Az-Zalzalah", "Al-'Adiyat", "Al-Qari'ah", "At-Takasur", "Al-'Asr", "Al-Humazah", "Al-Fil",
        "Quraisy", "Al-Ma'un", "Al-Kausar", "Al-Kafirun", "An-Nasr", "Al-Masad", "Al-Ikhlas", "Al-Falaq", "An-Nas"
    ];

    
    // --- MODAL CONTROLS ---
    window.openModal = function(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.querySelector('.modal-backdrop')?.classList.remove('opacity-0');
                modal.querySelector('.modal-content')?.classList.remove('scale-95');
            }, 10);
        }
    }

    window.closeModal = function(modalId) {
        const modal = document.getElementById(modalId);
         if (modal) {
            modal.querySelector('.modal-backdrop')?.classList.add('opacity-0');
            modal.querySelector('.modal-content')?.classList.add('scale-95');
            setTimeout(() => {
                modal.classList.add('hidden');
                const forms = modal.querySelectorAll('form');
                forms.forEach(form => form.reset());
                const hiddenInputs = modal.querySelectorAll('input[type="hidden"]');
                hiddenInputs.forEach(input => input.value = '');
            }, 300);
        }
    }

    // --- DYNAMIC SELECT POPULATION ---
    function populateSelectWithOptions(selectId, optionsArray, valueKey, textKey, firstOptionText) {
        const select = document.getElementById(selectId);
        select.innerHTML = '';

        if(firstOptionText){
            const firstOption = document.createElement('option');
            firstOption.value = '';
            firstOption.textContent = firstOptionText;
            select.appendChild(firstOption);
        }

        optionsArray.forEach(item => {
            const option = document.createElement('option');
            if(typeof item === 'object'){
                 option.value = item[valueKey];
                 option.textContent = item[textKey];
            } else {
                option.value = item;
                option.textContent = item;
            }
            select.appendChild(option);
        });
    }
    
    // --- NEW: PAGINATION RENDER ---
    function renderPagination(totalRows) {
        const paginationContainer = document.getElementById('pagination-container');
        if (!paginationContainer) return;

        const totalPages = Math.ceil(totalRows / rowsPerPage);
        paginationContainer.innerHTML = '';

        if (totalPages <= 1) return;

        // Previous Button
        let prevButton = document.createElement('button');
        prevButton.innerHTML = '&laquo; Seb';
        prevButton.className = "px-3 py-1 rounded-md bg-gray-200 hover:bg-gray-300 mr-1 disabled:opacity-50 disabled:cursor-not-allowed";
        if (currentPage === 1) prevButton.disabled = true;
        prevButton.onclick = () => {
            if (currentPage > 1) {
                currentPage--;
                renderSiswaTable();
            }
        };
        paginationContainer.appendChild(prevButton);

        // Page Info
        let pageInfo = document.createElement('span');
        pageInfo.className = "px-3 py-1 text-gray-700";
        pageInfo.textContent = `Hal ${currentPage} dari ${totalPages}`;
        paginationContainer.appendChild(pageInfo);

        // Next Button
        let nextButton = document.createElement('button');
        nextButton.innerHTML = 'Sel &raquo;';
        nextButton.className = "px-3 py-1 rounded-md bg-gray-200 hover:bg-gray-300 ml-1 disabled:opacity-50 disabled:cursor-not-allowed";
        if (currentPage === totalPages) nextButton.disabled = true;
        nextButton.onclick = () => {
            if (currentPage < totalPages) {
                currentPage++;
                renderSiswaTable();
            }
        };
        paginationContainer.appendChild(nextButton);
    }
    
    // --- NEW: LAPORAN PAGINATION RENDER ---
    function renderLaporanPagination(totalRows) {
        const paginationContainer = document.getElementById('laporan-pagination-container');
        if (!paginationContainer) return;

        const totalPages = Math.ceil(totalRows / rowsPerPage);
        paginationContainer.innerHTML = '';

        if (totalPages <= 1) return;

        // Previous Button
        let prevButton = document.createElement('button');
        prevButton.innerHTML = '&laquo; Seb';
        prevButton.className = "px-3 py-1 rounded-md bg-gray-200 hover:bg-gray-300 mr-1 disabled:opacity-50 disabled:cursor-not-allowed";
        if (laporanCurrentPage === 1) prevButton.disabled = true;
        prevButton.onclick = () => {
            if (laporanCurrentPage > 1) {
                laporanCurrentPage--;
                tampilkanLaporan(); // Panggil fungsi laporan
            }
        };
        paginationContainer.appendChild(prevButton);

        // Page Info
        let pageInfo = document.createElement('span');
        pageInfo.className = "px-3 py-1 text-gray-700";
        pageInfo.textContent = `Hal ${laporanCurrentPage} dari ${totalPages}`;
        paginationContainer.appendChild(pageInfo);

        // Next Button
        let nextButton = document.createElement('button');
        nextButton.innerHTML = 'Sel &raquo;';
        nextButton.className = "px-3 py-1 rounded-md bg-gray-200 hover:bg-gray-300 ml-1 disabled:opacity-50 disabled:cursor-not-allowed";
        if (laporanCurrentPage === totalPages) nextButton.disabled = true;
        nextButton.onclick = () => {
            if (laporanCurrentPage < totalPages) {
                laporanCurrentPage++;
                tampilkanLaporan(); // Panggil fungsi laporan
            }
        };
        paginationContainer.appendChild(nextButton);
    }



    // --- SISWA CRUD FUNCTIONS ---
     function renderSiswaTable() {
        const tableBody = document.getElementById('siswa-table')?.getElementsByTagName('tbody')[0];
        if(!tableBody) return;
        
        const searchTerm = document.getElementById('admin-search-siswa-input').value.toLowerCase();
            
        const filteredSiswa = siswaData.filter(siswa => 
            siswa.nama.toLowerCase().includes(searchTerm) || 
            siswa.nisn.includes(searchTerm) ||
            siswa.kelas_reguler.toLowerCase().includes(searchTerm) ||
            siswa.kelas_tahfizh.toLowerCase().includes(searchTerm)
        );
        
        // Pagination logic
        const startIndex = (currentPage - 1) * rowsPerPage;
        const endIndex = startIndex + rowsPerPage;
        const paginatedSiswa = filteredSiswa.slice(startIndex, endIndex);

        tableBody.innerHTML = '';
        if(paginatedSiswa.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="6" class="p-3 text-center text-gray-500">Tidak ada data siswa.</td></tr>';
            renderPagination(0, 0); // Clear pagination
            return;
        }

        paginatedSiswa.forEach((siswa, index) => {
            const globalIndex = startIndex + index; // Use this to find in original data
            const displayNumber = startIndex + index + 1; // Show correct number
            const newRow = tableBody.insertRow();
            newRow.className = 'border-b';
            const kelasGabungan = `${siswa.kelas_reguler}/${siswa.kelas_tahfizh}`;
            const pengajar = pengajarData.find(p => p.id === siswa.pengajar_id) || {};
            newRow.innerHTML = `
                <td class="p-3">${displayNumber}</td>
                <td class="p-3">${siswa.nisn}</td>
                <td class="p-3">${siswa.nama}</td>
                <td class="p-3">${kelasGabungan}</td>
                <td class="p-3">${pengajar.nama || 'N/A'}</td>
                <td class="p-3 whitespace-nowrap">
                    <button onclick="openViewSiswaModal(${globalIndex})" class="text-blue-500 hover:text-blue-700 mr-2"><i class="fas fa-eye"></i></button>
                    <button onclick="openEditSiswaModal(${globalIndex})" class="text-yellow-500 hover:text-yellow-700 mr-2"><i class="fas fa-pencil-alt"></i></button>
                    <button onclick="openDeleteModal('siswa', '${siswa.id}')" class="text-red-500 hover:text-red-700"><i class="fas fa-trash"></i></button>
                </td>
            `;
        });
        
        renderPagination(filteredSiswa.length);
    }

    window.openAddSiswaModal = function() {
        document.getElementById('siswaModalTitle').innerText = 'Tambah Siswa Baru';
        document.getElementById('editSiswaId').value = '';
        populateSelectWithOptions('kelasReguler', kelasRegulerData, 'nama_kelas', 'nama_kelas');
        populateSelectWithOptions('kelasTahfizh', kelasTahfizhData, 'nama_kelas', 'nama_kelas');
        populateSelectWithOptions('pembimbing', pengajarData, 'id', 'nama');
        openModal('siswaModal');
    }

    window.openEditSiswaModal = function(globalIndex) {
        const siswa = siswaData[globalIndex]; // Get from original data
        
        document.getElementById('siswaModalTitle').innerText = 'Edit Data Siswa';
        
        populateSelectWithOptions('kelasReguler', kelasRegulerData, 'nama_kelas', 'nama_kelas');
        populateSelectWithOptions('kelasTahfizh', kelasTahfizhData, 'nama_kelas', 'nama_kelas');
        populateSelectWithOptions('pembimbing', pengajarData, 'id', 'nama');

        document.getElementById('nisn').value = siswa.nisn;
        document.getElementById('nama').value = siswa.nama;
        document.getElementById('kelasReguler').value = siswa.kelas_reguler;
        document.getElementById('kelasTahfizh').value = siswa.kelas_tahfizh;
        document.getElementById('pembimbing').value = siswa.pengajar_id;
        document.getElementById('editSiswaId').value = siswa.id;
        
        openModal('siswaModal');
    }
    
    window.openViewSiswaModal = function(globalIndex) {
        const siswa = siswaData[globalIndex]; // Get from original data
        
        const kelasGabungan = `${siswa.kelas_reguler}/${siswa.kelas_tahfizh}`;
        const pengajar = pengajarData.find(p => p.id === siswa.pengajar_id) || {};
        document.getElementById('viewNisn').innerText = siswa.nisn;
        document.getElementById('viewNama').innerText = siswa.nama;
        document.getElementById('viewKelasSiswa').innerText = kelasGabungan;
        document.getElementById('viewPembimbing').innerText = pengajar.nama || 'N/A';
        openModal('viewSiswaModal');
    }

    async function handleSiswaFormSubmit(event) {
        event.preventDefault();
        const errorEl = document.getElementById('siswa-form-error');
        errorEl.classList.add('hidden');

        const editId = document.getElementById('editSiswaId').value;
        const nisnValue = document.getElementById('nisn').value;

        const siswaDataPayload = {
            nisn: nisnValue,
            nama: document.getElementById('nama').value,
            kelas_reguler: document.getElementById('kelasReguler').value,
            kelas_tahfizh: document.getElementById('kelasTahfizh').value,
            pengajar_id: document.getElementById('pembimbing').value,
        };

        if (editId) {
            const { error } = await supabaseClient.from('siswa').update(siswaDataPayload).eq('id', editId);
            if (error) {
                console.error("Error updating siswa:", error);
                errorEl.textContent = `Gagal memperbarui data: ${error.message}`;
                errorEl.classList.remove('hidden');
                return;
            }
        } else {
            const { error } = await supabaseClient.from('siswa').insert([siswaDataPayload]);
            if (error) {
                console.error("Error inserting siswa:", error);
                errorEl.textContent = `Gagal menambahkan siswa: ${error.message}`;
                errorEl.classList.remove('hidden');
                return;
            }
        }

        await fetchDataFromSupabase();
        await renderAll();
        closeModal('siswaModal');
    }

    // --- PENGAJAR CRUD ---
    function renderPengajarTable() {
        const tableBody = document.getElementById('pengajar-table').getElementsByTagName('tbody')[0];
        tableBody.innerHTML = '<tr><td colspan="3" class="p-3 text-center">Memuat data...</td></tr>';
        if (pengajarData.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="3" class="p-3 text-center text-gray-500">Belum ada data pengajar.</td></tr>';
            return;
        }
        tableBody.innerHTML = '';
        pengajarData.forEach((p, index) => {
            const newRow = tableBody.insertRow();
            newRow.className = 'border-b';
            newRow.innerHTML = `
                <td class="p-3">${index + 1}</td>
                <td class="p-3">${p.nama}</td>
                <td class="p-3 whitespace-nowrap">
                    <button onclick="openEditPengajarModal(${index})" class="text-yellow-500 hover:text-yellow-700 mr-2"><i class="fas fa-pencil-alt"></i></button>
                    <button onclick="openDeleteModal('pengajar', '${p.id}')" class="text-red-500 hover:text-red-700"><i class="fas fa-trash"></i></button>
                </td>
            `;
        });
    }

    window.openAddPengajarModal = function() {
        document.getElementById('pengajarModalTitle').innerText = 'Tambah Pengajar Baru';
        document.getElementById('editPengajarId').value = '';
        openModal('pengajarModal');
    }
    
    window.openEditPengajarModal = function(index) {
        const pengajar = pengajarData[index];
        document.getElementById('pengajarModalTitle').innerText = 'Edit Data Pengajar';
        document.getElementById('namaPengajar').value = pengajar.nama;
        document.getElementById('editPengajarId').value = pengajar.id;
        openModal('pengajarModal');
    }

    async function handlePengajarFormSubmit(event) {
        event.preventDefault();
        const nama = document.getElementById('namaPengajar').value;
        const editId = document.getElementById('editPengajarId').value;
        
        const pengajarPayload = { nama };

        if (editId) {
            const { error } = await supabaseClient.from('pengajar').update(pengajarPayload).eq('id', editId);
            if(error) console.error("Error updating pengajar:", error);
        } else {
            const { error } = await supabaseClient.from('pengajar').insert([pengajarPayload]);
            if(error) console.error("Error inserting pengajar:", error);
        }
        
        await fetchDataFromSupabase();
        await renderAll();
        closeModal('pengajarModal');
    }

    // --- KELAS CRUD ---
    function renderKelasTables() {
        const render = (tableId, dataArray, type) => {
            const tableBody = document.getElementById(tableId).getElementsByTagName('tbody')[0];
            tableBody.innerHTML = '';
            dataArray.forEach((kelas, index) => {
                const newRow = tableBody.insertRow();
                newRow.className = 'border-b';
                newRow.innerHTML = `
                    <td class="p-3">${kelas.nama_kelas}</td>
                    <td class="p-3 whitespace-nowrap">
                        <button onclick="openEditKelasModal('${type}', ${index})" class="text-yellow-500 hover:text-yellow-700 mr-2"><i class="fas fa-pencil-alt"></i></button>
                        <button onclick="openDeleteModal('kelas', '${kelas.id}')" class="text-red-500 hover:text-red-700"><i class="fas fa-trash"></i></button>
                    </td>
                `;
            });
        };
        render('kelas-reguler-table', kelasRegulerData, 'reguler');
        render('kelas-tahfizh-table', kelasTahfizhData, 'tahfizh');
    }
    
    window.openAddKelasModal = function(type) {
        document.getElementById('kelasModalTitle').innerText = `Tambah Kelas ${type === 'reguler' ? 'Reguler' : 'Tahfizh'} Baru`;
        document.getElementById('kelasType').value = type;
        document.getElementById('editKelasId').value = '';
        openModal('kelasModal');
    }

    window.openEditKelasModal = function(type, index) {
        const dataArray = type === 'reguler' ? kelasRegulerData : kelasTahfizhData;
        const kelas = dataArray[index];
        document.getElementById('kelasModalTitle').innerText = `Edit Kelas ${type === 'reguler' ? 'Reguler' : 'Tahfizh'}`;
        document.getElementById('namaKelas').value = kelas.nama_kelas;
        document.getElementById('kelasType').value = type;
        document.getElementById('editKelasId').value = kelas.id;
        openModal('kelasModal');
    }

    async function handleKelasFormSubmit(event) {
        event.preventDefault();
        const nama_kelas = document.getElementById('namaKelas').value;
        const tipe_kelas_raw = document.getElementById('kelasType').value;
        const editId = document.getElementById('editKelasId').value;
        
        const kelasPayload = {
            nama_kelas,
            tipe_kelas: tipe_kelas_raw.charAt(0).toUpperCase() + tipe_kelas_raw.slice(1) // Capitalize
        };

        if (editId) {
            const { error } = await supabaseClient.from('kelas').update(kelasPayload).eq('id', editId);
            if(error) console.error("Error updating kelas:", error);
        } else {
            const { error } = await supabaseClient.from('kelas').insert([kelasPayload]);
            if(error) console.error("Error inserting kelas:", error);
        }
        
        await fetchDataFromSupabase();
        await renderAll();
        closeModal('kelasModal');
    }

    // --- PENGGUNA CRUD ---
    function renderPenggunaTable() {
        const tableBody = document.getElementById('pengguna-table').getElementsByTagName('tbody')[0];
        tableBody.innerHTML = '<tr><td colspan="5" class="p-3 text-center">Memuat data...</td></tr>';
        if(userData.length === 0){
             tableBody.innerHTML = '<tr><td colspan="5" class="p-3 text-center text-gray-500">Belum ada data pengguna.</td></tr>';
            return;
        }
        tableBody.innerHTML = '';
        userData.forEach((user, index) => {
            const newRow = tableBody.insertRow();
            newRow.className = 'border-b';
            newRow.innerHTML = `
                <td class="p-3">${index + 1}</td>
                <td class="p-3">${user.username}</td>
                <td class="p-3">${user.nama}</td>
                <td class="p-3"><span class="px-2 py-1 text-xs font-medium rounded-full ${user.role === 'Admin' ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800'}">${user.role}</span></td>
                <td class="p-3 whitespace-nowrap">
                    <button onclick="openEditPenggunaModal(${index})" class="text-yellow-500 hover:text-yellow-700 mr-2"><i class="fas fa-pencil-alt"></i></button>
                    <button onclick="openDeleteModal('pengguna', '${user.id}')" class="text-red-500 hover:text-red-700"><i class="fas fa-trash"></i></button>
                </td>
            `;
        });
    }

    window.openAddPenggunaModal = function() {
        document.getElementById('penggunaModalTitle').innerText = 'Tambah Pengguna Baru';
        document.getElementById('editPenggunaId').value = '';
        document.getElementById('usernamePengguna').disabled = false;
        document.getElementById('passwordPengguna').required = true;
        document.getElementById('passwordPengguna').placeholder = '';
        
        const namaPenggunaSelect = document.getElementById('namaPengguna');
        namaPenggunaSelect.disabled = false;
        const usernamePenggunaInput = document.getElementById('usernamePengguna');
        const rolePenggunaSelect = document.getElementById('rolePengguna');

        const userNames = userData.map(u => u.nama);
        const availableTeachers = pengajarData.filter(p => !userNames.includes(p.nama));
        populateSelectWithOptions('namaPengguna', availableTeachers, 'nama', 'nama', 'Pilih dari daftar guru...');
        
        namaPenggunaSelect.onchange = function() {
            if (this.value) {
                const usernameSuggestion = this.value.toLowerCase().replace(/[^a-z0-9]/g, '');
                usernamePenggunaInput.value = usernameSuggestion;
                rolePenggunaSelect.value = 'Guru';
            } else {
                 usernamePenggunaInput.value = '';
            }
        };

        openModal('penggunaModal');
    }

    window.openEditPenggunaModal = function(index) {
        const user = userData[index];
        document.getElementById('penggunaModalTitle').innerText = 'Edit Data Pengguna';
        document.getElementById('usernamePengguna').value = user.username;
        document.getElementById('usernamePengguna').disabled = true; 
        document.getElementById('passwordPengguna').required = false; 
        document.getElementById('passwordPengguna').placeholder = 'Kosongkan jika tidak diubah';
        document.getElementById('rolePengguna').value = user.role;
        document.getElementById('editPenggunaId').value = user.id;

        const namaPenggunaSelect = document.getElementById('namaPengguna');
        namaPenggunaSelect.innerHTML = `<option value="${user.nama}">${user.nama}</option>`;
        namaPenggunaSelect.disabled = true;

        openModal('penggunaModal');
    }

    async function handlePenggunaFormSubmit(event) {
        event.preventDefault();
        const editId = document.getElementById('editPenggunaId').value;
        const password = document.getElementById('passwordPengguna').value;
        
        const userPayload = {
            username: document.getElementById('usernamePengguna').value,
            nama: document.getElementById('namaPengguna').value,
            role: document.getElementById('rolePengguna').value,
        };

        if (editId) {
            if (password) {
                userPayload.password = password;
            }
             const { error } = await supabaseClient.from('pengguna').update(userPayload).eq('id', editId);
            if(error) console.error("Error updating user:", error);
        } else {
            userPayload.password = password;
            const { error } = await supabaseClient.from('pengguna').insert([userPayload]);
            if(error) console.error("Error inserting user:", error);
        }
        
        await fetchDataFromSupabase();
        await renderAll();
        closeModal('penggunaModal');
    }


    // --- GENERIC DELETE ---
    window.openDeleteModal = async function(tableName, id) {
        Swal.fire({
            title: 'Anda yakin?',
            text: "Data ini akan dihapus permanen dan tidak dapat dibatalkan.",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#0A6847',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Ya, Hapus!',
            cancelButtonText: 'Batal'
        }).then(async (result) => {
            if (result.isConfirmed) {
                const { error } = await supabaseClient.from(tableName).delete().eq('id', id);
                if (error) {
                    Swal.fire('Gagal!', `Data gagal dihapus: ${error.message}`, 'error');
                } else {
                    Swal.fire('Berhasil!', 'Data telah dihapus.', 'success');
                    await fetchDataFromSupabase();
                    await renderAll();
                }
            }
        })
    }
    
    // --- SEARCHABLE SISWA DROPDOWN (Generic) ---
    function setupSearchableDropdown(inputId, containerId, dataArray, onSelect) {
        const searchInput = document.getElementById(inputId);
        const optionsContainer = document.getElementById(containerId);

        const populateOptions = (filter = '') => {
            optionsContainer.innerHTML = '';
            const filteredData = dataArray.filter(item => 
                (typeof item === 'string' ? item : item.nama).toLowerCase().includes(filter.toLowerCase())
            );

            if (filteredData.length === 0) {
                optionsContainer.innerHTML = `<div class="p-3 text-gray-500">Tidak ditemukan</div>`;
                return;
            }

            filteredData.forEach(item => {
                const itemEl = document.createElement('div');
                itemEl.className = 'p-3 hover:bg-gray-100 cursor-pointer';
                if (typeof item === 'string') {
                    itemEl.textContent = item;
                    itemEl.dataset.value = item;
                } else {
                    itemEl.textContent = `${item.nama} - ${item.kelas_reguler}/${item.kelas_tahfizh}`;
                    itemEl.dataset.value = item.nama;
                }
                
                itemEl.onmousedown = (e) => {
                    e.preventDefault();
                    searchInput.value = itemEl.dataset.value;
                    optionsContainer.classList.add('hidden');
                    if(onSelect) onSelect(item);
                };
                optionsContainer.appendChild(itemEl);
            });
        };

        searchInput.addEventListener('focus', () => {
            populateOptions(searchInput.value);
            optionsContainer.classList.remove('hidden');
        });
        
        searchInput.addEventListener('blur', () => {
            setTimeout(() => optionsContainer.classList.add('hidden'), 200);
        });
        
        searchInput.addEventListener('keyup', () => {
            populateOptions(searchInput.value);
        });
        
        return { populate: populateOptions };
    }


    // --- POPULATE PENILAIAN FORMS ---
    function populatePenilaiOptions(currentUser) {
        const dinilaiOlehSelect = document.getElementById('dinilai-oleh');
        if (currentUser && currentUser.role === 'Guru') {
            const currentPengajar = pengajarData.find(p => p.nama === currentUser.nama);
            if(currentPengajar){
                dinilaiOlehSelect.innerHTML = `<option value="${currentPengajar.id}">${currentPengajar.nama}</option>`;
                dinilaiOlehSelect.value = currentPengajar.id;
                dinilaiOlehSelect.disabled = true;
            } else {
                // Fallback for user not in pengajar list (e.g., admin)
                populateSelectWithOptions('dinilai-oleh', pengajarData, 'id', 'nama', 'Pilih pengajar...');
                dinilaiOlehSelect.disabled = false;
            }
        } else {
            populateSelectWithOptions('dinilai-oleh', pengajarData, 'id', 'nama', 'Pilih pengajar...');
            dinilaiOlehSelect.disabled = false;
        }
    }

    // --- LAPORAN LOGIC ---
    function getSiswaByNama(nama) {
        return siswaData.find(s => s.nama.toLowerCase() === nama.toLowerCase());
    }

    // --- NEW: Filter Laporan (Resets Page) ---
    window.filterLaporan = function() {
        laporanCurrentPage = 1;
        tampilkanLaporan();
    }

    window.tampilkanLaporan = function() {
        const hasilContainer = document.getElementById('laporan-hasil-container');
        const titleEl = document.getElementById('laporan-title');
        const headEl = document.getElementById('laporan-table-head');
        const bodyEl = document.getElementById('laporan-table-body');
        
        const filterKelas = document.getElementById('laporan-pilih-kelas').value;
        const filterSiswaNama = document.getElementById('laporan-search-siswa-input').value;
        
        let dataToRender = penilaianData;
        
        // --- MODIFIED: BASE FILTER FOR GURU ---
        if (currentUser && currentUser.role === 'Guru') {
            const currentPengajar = pengajarData.find(p => p.nama === currentUser.nama);
            if (currentPengajar) {
                const mySiswaIds = siswaData
                    .filter(s => s.pengajar_id == currentPengajar.id)
                    .map(s => s.id);
                dataToRender = penilaianData.filter(p => mySiswaIds.includes(p.siswa_id));
            } else {
                dataToRender = []; // No teacher, no data
            }
        }
        // --- END MODIFICATION ---

        let mode = 'default';
        let title = 'Laporan Keseluruhan';

        // Apply filters
        if (filterSiswaNama) {
            const siswaObj = getSiswaByNama(filterSiswaNama);
            if(siswaObj) {
                dataToRender = dataToRender.filter(p => p.siswa_id === siswaObj.id);
                mode = 'siswa';
                title = `Laporan untuk: ${siswaObj.nama}`;
            }
        } else if (filterKelas) {
            const siswaDiKelas = siswaData.filter(s => s.kelas_tahfizh === filterKelas).map(s => s.id);
            dataToRender = dataToRender.filter(p => siswaDiKelas.includes(p.siswa_id));
            mode = 'kelas';
            title = `Laporan untuk Kelas Tahfizh: ${filterKelas}`;
        }
        
        titleEl.textContent = title;
        headEl.innerHTML = '';
        bodyEl.innerHTML = '';

        // Generate table header based on mode
        let headerHtml = '';
        if (mode === 'siswa') {
            headerHtml = `<tr>
                <th class="p-3">Tanggal</th><th class="p-3">Jenis</th><th class="p-3">Detail</th>
                <th class="p-3">Hasil</th><th class="p-3">Catatan</th><th class="p-3">Dinilai oleh</th>
            </tr>`;
        } else if (mode === 'kelas') {
            headerHtml = `<tr>
                <th class="p-3">Tanggal</th><th class="p-3">Nama</th><th class="p-3">Jenis</th>
                <th class="p-3">Detail</th><th class="p-3">Hasil</th><th class="p-3">Catatan</th>
                <th class="p-3">Dinilai oleh</th>
            </tr>`;
        } else { // default
            headerHtml = `<tr>
                <th class="p-3">Tanggal</th><th class="p-3">Nama</th><th class="p-3">Kelas</th>
                <th class="p-3">Jenis</th><th class="p-3">Detail</th><th class="p-3">Hasil</th>
                <th class="p-3">Catatan</th><th class="p-3">Dinilai oleh</th>
            </tr>`;
        }
        headEl.innerHTML = headerHtml;

        // --- NEW PAGINATION LOGIC ---
        const sortedData = dataToRender.sort((a, b) => new Date(b.tanggal) - new Date(a.tanggal));
        const totalRows = sortedData.length;
        const startIndex = (laporanCurrentPage - 1) * rowsPerPage;
        const endIndex = startIndex + rowsPerPage;
        const paginatedData = sortedData.slice(startIndex, endIndex);

        // Generate table body
        if(paginatedData.length === 0){
            const colCount = headEl.querySelector('tr').children.length;
            bodyEl.innerHTML = `<tr><td colspan="${colCount}" class="p-3 text-center text-gray-500">Tidak ada data untuk ditampilkan.</td></tr>`;
            renderLaporanPagination(0); // Clear pagination
        } else {
             paginatedData.forEach(item => {
                const siswa = siswaData.find(s => s.id === item.siswa_id) || {};
                const pengajar = pengajarData.find(p => p.id === item.penilai_id) || {};
                const kelasGabungan = `${siswa.kelas_reguler || ''}/${siswa.kelas_tahfizh || ''}`;
                const newRow = bodyEl.insertRow();
                newRow.className = 'border-b';
                
                let rowHtml = `<td class="p-3">${new Date(item.tanggal).toLocaleDateString('id-ID')}</td>`;

                if(mode !== 'siswa') {
                    rowHtml += `<td class="p-3">${siswa.nama || 'N/A'}</td>`;
                }
                if(mode === 'default') {
                     rowHtml += `<td class="p-3">${kelasGabungan}</td>`;
                }
                
                let detailText = '';
                if(item.jenis_penilaian === 'Iqro') {
                    detailText = `Jilid ${item.jilid || '-'}, Hal ${item.halaman || '-'}`;
                    if(item.baris_dari) detailText += `, Baris ${item.baris_dari}-${item.baris_sampai || ''}`;
                } else {
                    detailText = `${item.surat || '-'} Ayat ${item.ayat_dari || '-'}-${item.ayat_sampai || '-'}`;
                }

                rowHtml += `<td class="p-3">${item.jenis_penilaian}</td>
                            <td class="p-3">${detailText}</td>
                            <td class="p-3">${item.hasil}</td>
                            <td class="p-3">${item.catatan || '-'}</td>
                            <td class="p-3">${pengajar.nama || 'N/A'}</td>`;

                newRow.innerHTML = rowHtml;
            });
            renderLaporanPagination(totalRows); // Render pagination
        }
        // --- END PAGINATION LOGIC ---
       
        hasilContainer.classList.remove('hidden');
    }
    
    // --- NEW: RENDER GURU'S SISWA TABLE ON DASHBOARD ---
    function renderGuruSiswaTable(guruId) {
        const tableBody = document.getElementById('guru-siswa-table')?.getElementsByTagName('tbody')[0];
        if (!tableBody) return;

        const searchTerm = document.getElementById('guru-search-siswa-input').value.toLowerCase();

        const mySiswa = siswaData.filter(s => s.pengajar_id == guruId);
        
        const filteredSiswa = mySiswa.filter(siswa => 
            siswa.nama.toLowerCase().includes(searchTerm) || 
            (siswa.nisn && siswa.nisn.includes(searchTerm))
        );
        
        tableBody.innerHTML = '';
        if (filteredSiswa.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="4" class="p-3 text-center text-gray-500">Siswa tidak ditemukan.</td></tr>';
            return;
        }

        filteredSiswa.forEach((siswa, index) => {
            const newRow = tableBody.insertRow();
            newRow.className = 'border-b';
            const kelasGabungan = `${siswa.kelas_reguler}/${siswa.kelas_tahfizh}`;
            newRow.innerHTML = `
                <td class="p-3">${index + 1}</td>
                <td class="p-3">${siswa.nisn}</td>
                <td class="p-3">${siswa.nama}</td>
                <td class="p-3">${kelasGabungan}</td>
            `;
        });
    }

    // --- NEW: RENDER GURU'S RIWAYAT TABLE ---
    window.renderRiwayatGuruTable = function(user) {
        const tableBody = document.getElementById('riwayat-guru-table')?.getElementsByTagName('tbody')[0];
        if (!tableBody || !user || user.role !== 'Guru') {
            if(tableBody) tableBody.innerHTML = '<tr><td colspan="7" class="p-3 text-center text-gray-500">Hanya guru yang dapat melihat riwayat ini.</td></tr>';
            return;
        }
        
        const jenisPenilaian = document.getElementById('riwayat-jenis-penilaian').value;
        if (!jenisPenilaian) {
            tableBody.innerHTML = '<tr><td colspan="7" class="p-3 text-center text-gray-500">Silakan pilih jenis penilaian untuk melihat riwayat.</td></tr>';
            return;
        }

        const currentPengajar = pengajarData.find(p => p.nama === user.nama);
        if (!currentPengajar) {
             tableBody.innerHTML = '<tr><td colspan="7" class="p-3 text-center text-gray-500">Data pengajar tidak ditemukan.</td></tr>';
            return;
        }
        
        const mySiswa = siswaData.filter(s => s.pengajar_id == currentPengajar.id);
        if (mySiswa.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="7" class="p-3 text-center text-gray-500">Anda belum memiliki siswa bimbingan.</td></tr>';
            return;
        }
        
        tableBody.innerHTML = ''; // Clear table
        
        mySiswa.forEach((siswa, index) => {
            const riwayatSiswa = penilaianData
                .filter(p => p.siswa_id === siswa.id && p.jenis_penilaian === jenisPenilaian)
                .sort((a, b) => new Date(b.tanggal) - new Date(a.tanggal));

            const newRow = tableBody.insertRow();
            newRow.className = 'border-b';
            
            if (riwayatSiswa.length > 0) {
                const terakhir = riwayatSiswa[0];
                const pengajar = pengajarData.find(p => p.id === terakhir.penilai_id) || {};
                let detailText = '';
                if(terakhir.jenis_penilaian === 'Iqro') {
                    detailText = `Jilid ${terakhir.jilid || '-'}, Hal ${terakhir.halaman || '-'}`;
                     if(terakhir.baris_dari) detailText += `, Baris ${terakhir.baris_dari}-${terakhir.baris_sampai || ''}`;
                } else {
                    detailText = `${terakhir.surat || '-'} Ayat ${terakhir.ayat_dari || '-'}-${terakhir.ayat_sampai || '-'}`;
                }
                
                newRow.innerHTML = `
                    <td class="p-3">${index + 1}</td>
                    <td class="p-3">${siswa.nama}</td>
                    <td class="p-3">${detailText}</td>
                    <td class="p-3">${terakhir.hasil}</td>
                    <td class="p-3">${terakhir.catatan || '-'}</td>
                    <td class="p-3">${pengajar.nama || 'N/A'}</td>
                    <td class="p-3">${new Date(terakhir.tanggal).toLocaleString('id-ID', { dateStyle: 'medium', timeStyle: 'short' })}</td>
                `;
            } else {
                newRow.innerHTML = `
                    <td class="p-3">${index + 1}</td>
                    <td class="p-3">${siswa.nama}</td>
                    <td class="p-3 text-gray-400 italic">Belum ada data</td>
                    <td class="p-3 text-gray-400 italic">-</td>
                    <td class="p-3 text-gray-400 italic">-</td>
                    <td class="p-3 text-gray-400 italic">-</td>
                    <td class="p-3 text-gray-400 italic">-</td>
                `;
            }
        });
    }


    // --- RENDER & UPDATE ---
    function updateDashboardStats(user) {
        document.getElementById('total-siswa').textContent = siswaData.length;
        document.getElementById('total-pengajar').textContent = pengajarData.length;
        document.getElementById('total-kelas').textContent = kelasRegulerData.length + kelasTahfizhData.length;

        // --- PERBAIKAN ZONA WAKTU ---
        // 1. Dapatkan tanggal hari ini di zona waktu LOKAL pengguna (Format: YYYY-MM-DD)
        const today = new Date();
        const localTodayString = today.toLocaleDateString('id-ID', { year: 'numeric', month: '2-digit', day: '2-digit' }).split('/').reverse().join('-');

        // 2. Filter data penilaian
        const countPenilaianHariIni = penilaianData.filter(p => {
            if (!p.tanggal) return false;
            // Ubah tanggal UTC dari database ke tanggal LOKAL
            const assessmentDate = new Date(p.tanggal);
            const localAssessmentDateString = assessmentDate.toLocaleDateString('id-ID', { year: 'numeric', month: '2-digit', day: '2-digit' }).split('/').reverse().join('-');
            
            return localAssessmentDateString === localTodayString;
        }).length;
        // --- AKHIR PERBAIKAN ---
        
        document.getElementById('total-penilaian-hari-ini').textContent = countPenilaianHariIni;
        
        // --- NEW GURU STATS ---
        if (user && user.role === 'Guru') {
            const currentPengajar = pengajarData.find(p => p.nama === user.nama);
            if (currentPengajar) {
                const jumlahBimbingan = siswaData.filter(s => s.pengajar_id == currentPengajar.id).length;
                document.getElementById('total-siswa-bimbingan').textContent = jumlahBimbingan;
                
                // --- RENDER TABLE ---
                renderGuruSiswaTable(currentPengajar.id);
            }
        }
    }

    async function renderAll() {
        renderSiswaTable();
        renderPengajarTable();
        renderKelasTables();
        renderPenggunaTable();
        updateDashboardStats(currentUser); // Pass currentUser
        
        // --- Role-based data filtering for dropdowns ---
        let siswaLaporan = siswaData;
        let kelasLaporan = kelasTahfizhData;

        if (currentUser && currentUser.role === 'Guru') {
            const currentPengajar = pengajarData.find(p => p.nama === currentUser.nama);
            if (currentPengajar) {
                // Filter for Laporan page
                siswaLaporan = siswaData.filter(s => s.pengajar_id == currentPengajar.id);
                const kelasSet = new Set(siswaLaporan.map(s => s.kelas_tahfizh));
                kelasLaporan = Array.from(kelasSet).map(nama_kelas => ({ nama_kelas: nama_kelas })); 
            } else {
                siswaLaporan = []; // No teacher data found, show no students
                kelasLaporan = [];
            }
        }
        
        // Populate dropdowns based on role
        // Input Penilaian: SELALU TAMPILKAN SEMUA SISWA
        setupSearchableDropdown('search-siswa-input', 'siswa-options-container', siswaData, displayLastAssessment).populate();
        
        // Laporan: Tampilkan siswa bimbingan (jika guru) atau semua siswa (jika admin)
        setupSearchableDropdown('laporan-search-siswa-input', 'laporan-siswa-options-container', siswaLaporan).populate();
        
        // Public search dropdown on login page MUST show all students
        setupSearchableDropdown('public-student-search-input', 'public-student-options-container', siswaData).populate(); 
        
        // Laporan class dropdown: Tampilkan kelas bimbingan (jika guru) atau semua kelas (jika admin)
        populateSelectWithOptions('laporan-pilih-kelas', kelasLaporan, 'nama_kelas', 'nama_kelas', 'Semua Kelas Tahfizh');
    }

    async function fetchDataFromSupabase() {
        const { data: users, error: userError } = await supabaseClient.from('pengguna').select('*');
        if (userError) console.error('Error fetching users:', userError); else userData = users;

        const { data: teachers, error: teacherError } = await supabaseClient.from('pengajar').select('*');
        if (teacherError) console.error('Error fetching teachers:', teacherError); else pengajarData = teachers;

        const { data: students, error: studentError } = await supabaseClient.from('siswa').select('*');
        if (studentError) console.error('Error fetching students:', studentError); else siswaData = students;

        const { data: classes, error: classError } = await supabaseClient.from('kelas').select('*');
        if (classError) console.error('Error fetching classes:', classError); 
        else {
            kelasRegulerData = classes.filter(c => c.tipe_kelas === 'Reguler');
            kelasTahfizhData = classes.filter(c => c.tipe_kelas === 'Tahfizh');
        }

        const { data: assessments, error: assessmentError } = await supabaseClient.from('penilaian').select('*');
        if (assessmentError) console.error('Error fetching assessments:', assessmentError); else penilaianData = assessments;
    }

    // --- DISPLAY LAST ASSESSMENT ---
    window.displayLastAssessment = function() {
        const riwayatContainer = document.getElementById('riwayat-terakhir-container');
        const riwayatContent = document.getElementById('riwayat-terakhir-content');
        const siswaNama = document.getElementById('search-siswa-input').value;
        const jenisPenilaian = document.getElementById('jenis-penilaian').value;

        if (!siswaNama || !jenisPenilaian) {
            riwayatContainer.classList.add('hidden');
            return;
        }

        const siswa = getSiswaByNama(siswaNama);
        if (!siswa) {
            riwayatContainer.classList.add('hidden');
            return;
        }

        const riwayatSiswa = penilaianData
            .filter(p => p.siswa_id === siswa.id && p.jenis_penilaian === jenisPenilaian)
            .sort((a, b) => new Date(b.tanggal) - new Date(a.tanggal));

        riwayatContainer.classList.remove('hidden');

        if (riwayatSiswa.length > 0) {
            const terakhir = riwayatSiswa[0];
            const pengajar = pengajarData.find(p => p.id === terakhir.penilai_id) || {};
            let detailText = '';
            if(terakhir.jenis_penilaian === 'Iqro') {
                detailText = `Jilid ${terakhir.jilid || '-'}, Hal ${terakhir.halaman || '-'}`;
                 if(terakhir.baris_dari) detailText += `, Baris ${terakhir.baris_dari}-${terakhir.baris_sampai || ''}`;
            } else {
                detailText = `${terakhir.surat || '-'} Ayat ${terakhir.ayat_dari || '-'}-${terakhir.ayat_sampai || '-'}`;
            }
            riwayatContent.innerHTML = `
                <span class="font-medium">${new Date(terakhir.tanggal).toLocaleString('id-ID', { dateStyle: 'medium', timeStyle: 'short' })}:</span> ${detailText}
                <br>
                <span class="font-medium">Hasil:</span> ${terakhir.hasil} <span class="italic text-gray-500">(dinilai oleh ${pengajar.nama || 'N/A'})</span>
                <br>
                <span class="font-medium">Catatan:</span> <span class="italic text-gray-500">${terakhir.catatan || 'Tidak ada catatan'}</span>
            `;
        } else {
            riwayatContent.textContent = 'Belum ada riwayat penilaian untuk jenis ini.';
        }
    }


    // --- NAVIGATION & INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', async () => {
        await fetchDataFromSupabase();
        // await renderAll(); // Don't render all yet, wait for login
        
        setupSearchableDropdown('surat-ayat-surat', 'surat-options-container', daftarSurat);

        const navLinks = document.querySelectorAll('.nav-link');
        const pageContents = document.querySelectorAll('.page-content');
        const pageTitle = document.getElementById('page-title');
        const sidebar = document.getElementById('sidebar');
        const mainContent = document.querySelector('main');
        const sidebarToggle = document.getElementById('sidebar-toggle');
        const sidebarOverlay = document.getElementById('sidebar-overlay');
        const menuOpenIcon = document.getElementById('menu-open-icon');
        const menuCloseIcon = document.getElementById('menu-close-icon');

        // --- NEW: AVATAR DROPDOWN ---
        const avatarButton = document.getElementById('avatar-button');
        const userDropdown = document.getElementById('user-dropdown');
        
        if(avatarButton) {
            avatarButton.addEventListener('click', () => {
                userDropdown.classList.toggle('hidden');
            });
        }
        
        // Close dropdown if clicking outside
        window.addEventListener('click', (e) => {
            if (userDropdown && avatarButton && !avatarButton.contains(e.target) && !userDropdown.contains(e.target)) {
                userDropdown.classList.add('hidden');
            }
        });
        // --- END NEW ---
        
        // --- AUTHENTICATION ---
        function updateUIAfterLogin(user) {
            document.getElementById('welcome-message').textContent = `Selamat datang, ${user.nama}!`;
            const userInitial = user.nama.charAt(0).toUpperCase();
            document.getElementById('user-avatar').src = `https://placehold.co/100x100/0A6847/FFFFFF?text=${userInitial}`;
            document.getElementById('user-avatar').alt = `Avatar for ${user.nama}`;
            
            const adminOnlyElements = document.querySelectorAll('[data-role="admin"]');
            const guruOnlyElements = document.querySelectorAll('[data-role="guru"]'); // Get guru elements

            if (user.role === 'Guru') {
                adminOnlyElements.forEach(el => el.classList.add('hidden'));
                guruOnlyElements.forEach(el => el.classList.remove('hidden')); // Show guru elements
                window.location.hash = '#dashboard'; 
                showPage('#dashboard'); 
            } else { // Admin
                adminOnlyElements.forEach(el => el.classList.remove('hidden'));
                guruOnlyElements.forEach(el => el.classList.add('hidden')); // Hide guru elements
                window.location.hash = '#dashboard';
                showPage('#dashboard');
            }
            populatePenilaiOptions(user); 
            updateDashboardStats(user); // <-- Pass the user
            renderAll(); // Re-render all to apply filters
        }

        async function handleLogin(event) {
            event.preventDefault();
            const form = event.target;
            const usernameInput = form.querySelector('input[name="username"]');
            const passwordInput = form.querySelector('input[name="password"]');
            const errorMsg = form.querySelector('p');

            const { data: user, error } = await supabaseClient
                .from('pengguna')
                .select('*')
                .eq('username', usernameInput.value)
                .eq('password', passwordInput.value)
                .single();

            if (user && !error) {
                currentUser = user;
                await fetchDataFromSupabase(); // Fetch data *after* knowing who the user is
                updateUIAfterLogin(currentUser); // Update UI
                renderAll(); // Render again with filtered data
                document.getElementById('login-page').classList.add('hidden');
                document.getElementById('main-app').classList.remove('hidden');
                closeModal('staffLoginModal');
            } else {
                errorMsg.classList.remove('hidden');
            }
        }

        function handleLogout() {
            currentUser = null;
            document.body.classList.remove('overflow-hidden');
            document.getElementById('login-page').classList.remove('hidden');
            document.getElementById('main-app').classList.add('hidden');
            document.getElementById('student-report-page').classList.add('hidden');
            window.location.hash = '#dashboard';
        }
        
        async function handlePenilaianFormSubmit(event) {
            event.preventDefault();

            // --- PERBAIKAN DIMULAI DI SINI ---
            const form = event.target;
            // Validasi form manual untuk memastikan semua field 'required' terisi
            if (!form.checkValidity()) {
                // Memicu validasi bawaan browser untuk menampilkan pesan error
                form.reportValidity(); 
                return; // Hentikan fungsi jika form tidak valid
            }
            // --- PERBAIKAN SELESAI ---

            const btn = document.getElementById('simpan-penilaian-button');
            const btnSpan = btn.querySelector('span');
            btn.disabled = true;
            btnSpan.textContent = 'Menyimpan...';

            const siswaNama = document.getElementById('search-siswa-input').value;
            const siswa = getSiswaByNama(siswaNama);

            if(!siswa) {
                Swal.fire({ icon: 'error', title: 'Gagal', text: 'Siswa tidak valid! Silakan pilih dari daftar.' });
                btn.disabled = false;
                btnSpan.textContent = 'Simpan Penilaian';
                return;
            }

            const jenis_penilaian = document.getElementById('jenis-penilaian').value;
            
            const penilaianPayload = {
                tanggal: new Date().toISOString(),
                siswa_id: siswa.id,
                penilai_id: document.getElementById('dinilai-oleh').value,
                jenis_penilaian: jenis_penilaian,
                hasil: document.getElementById('common-hasil').value,
                catatan: document.getElementById('common-catatan').value,
                jilid: null,
                halaman: null,
                baris_dari: null,
                baris_sampai: null,
                surat: null,
                ayat_dari: null,
                ayat_sampai: null,
            };

            if (jenis_penilaian === 'Iqro') {
                penilaianPayload.jilid = document.getElementById('iqro-jilid').value || null;
                penilaianPayload.halaman = document.getElementById('iqro-halaman').value || null;
                penilaianPayload.baris_dari = document.getElementById('iqro-baris-dari').value || null;
                penilaianPayload.baris_sampai = document.getElementById('iqro-baris-sampai').value || null;
            } else {
                penilaianPayload.surat = document.getElementById('surat-ayat-surat').value || null;
                penilaianPayload.ayat_dari = document.getElementById('surat-ayat-dari').value || null;
                penilaianPayload.ayat_sampai = document.getElementById('surat-ayat-sampai').value || null;
            }

            const { error } = await supabaseClient.from('penilaian').insert([penilaianPayload]);
            
            if(error) {
                console.error("Gagal menyimpan penilaian:", error);
                 Swal.fire({ icon: 'error', title: 'Gagal', text: `Gagal menyimpan penilaian: ${error.message}` });
            } else {
                 Swal.fire({ icon: 'success', title: 'Berhasil', text: 'Penilaian berhasil disimpan!', timer: 1500, showConfirmButton: false });
                document.getElementById('penilaian-form').reset();
                document.getElementById('form-penilaian-container').classList.add('hidden');
                document.getElementById('riwayat-terakhir-container').classList.add('hidden'); // Sembunyikan riwayat
                await fetchDataFromSupabase();
                await renderAll();
            }
            btn.disabled = false;
            btnSpan.textContent = 'Simpan Penilaian';
        }

        document.getElementById('login-form-modal').addEventListener('submit', handleLogin);
        document.getElementById('logout-button').addEventListener('click', (e) => {
            e.preventDefault();
            if(userDropdown) userDropdown.classList.add('hidden'); // Also hide dropdown on logout
            handleLogout();
        });

        // Other setups
        setupSearchableDropdown('search-siswa-input', 'siswa-options-container', siswaData, displayLastAssessment);
        setupSearchableDropdown('laporan-search-siswa-input', 'laporan-siswa-options-container', siswaData);
        setupSearchableDropdown('public-student-search-input', 'public-student-options-container', siswaData);
        
        // Penilaian form dynamic fields
        document.getElementById('jenis-penilaian').addEventListener('change', function() {
            const formContainer = document.getElementById('form-penilaian-container');
            const iqroFields = document.getElementById('iqro-fields');
            const suratAyatFields = document.getElementById('surat-ayat-fields');
            
            // Mengatur input Iqro
            document.getElementById('iqro-jilid').required = (this.value === 'Iqro');
            document.getElementById('iqro-halaman').required = (this.value === 'Iqro');
            document.getElementById('iqro-baris-dari').required = (this.value === 'Iqro');
            document.getElementById('iqro-baris-sampai').required = (this.value === 'Iqro');

            // Mengatur input Surat
            document.getElementById('surat-ayat-surat').required = (this.value !== 'Iqro' && this.value !== '');
            document.getElementById('surat-ayat-dari').required = (this.value !== 'Iqro' && this.value !== '');
            document.getElementById('surat-ayat-sampai').required = (this.value !== 'Iqro' && this.value !== '');
            
            const selectedValue = this.value;
            displayLastAssessment();


            if (!selectedValue) {
                formContainer.classList.add('hidden');
                return;
            }

            formContainer.classList.remove('hidden');
            if (selectedValue === 'Iqro') {
                iqroFields.classList.remove('hidden');
                suratAyatFields.classList.add('hidden');
            } else {
                iqroFields.classList.add('hidden');
                suratAyatFields.classList.remove('hidden');
            }
        });

        function toggleSidebar() {
            sidebar.classList.toggle('-translate-x-full');
            mainContent.classList.toggle('translate-x-64');
            sidebarOverlay.classList.toggle('hidden');
            menuOpenIcon.classList.toggle('hidden');
            menuCloseIcon.classList.toggle('hidden');
            const isSidebarOpen = !sidebar.classList.contains('-translate-x-full');
            document.body.classList.toggle('overflow-hidden', isSidebarOpen);
        }

        sidebarToggle.addEventListener('click', toggleSidebar);
        sidebarOverlay.addEventListener('click', toggleSidebar);

        function showPage(hash) {
            const targetId = hash.substring(1);
            pageContents.forEach(content => {
                content.classList.toggle('hidden', content.id !== targetId);
            });

            navLinks.forEach(link => {
                if (link.getAttribute('href') === hash) {
                    link.classList.add('bg-gray-700');
                    pageTitle.textContent = link.querySelector('span').textContent;
                } else {
                    link.classList.remove('bg-gray-700');
                }
            });
            
            // NEW: Jalankan render tabel riwayat jika halaman riwayat guru dibuka
            if(hash === '#riwayat-guru' && currentUser) {
                renderRiwayatGuruTable(currentUser);
            }

            if (window.innerWidth < 768 && !sidebar.classList.contains('-translate-x-full')) {
                toggleSidebar();
            }
        }
        
        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const hash = e.currentTarget.getAttribute('href');
                window.location.hash = hash;
            });
        });

        window.addEventListener('hashchange', () => {
            const hash = window.location.hash || '#dashboard';
            showPage(hash);
        });

        const initialHash = window.location.hash || '#dashboard';
        showPage(initialHash);

        // Student Report Logic
        document.getElementById('open-staff-login-button').addEventListener('click', () => openModal('staffLoginModal'));
        document.getElementById('student-report-form').addEventListener('submit', handleStudentReportRequest);
        document.getElementById('back-to-login-button').addEventListener('click', hideStudentReport);
        
        document.getElementById('siswaForm').addEventListener('submit', handleSiswaFormSubmit);
        document.getElementById('pengajarForm').addEventListener('submit', handlePengajarFormSubmit);
        document.getElementById('kelasForm').addEventListener('submit', handleKelasFormSubmit);
        document.getElementById('penggunaForm').addEventListener('submit', handlePenggunaFormSubmit);
        document.getElementById('penilaian-form').addEventListener('submit', handlePenilaianFormSubmit);
        
        // NEW: Event listener for riwayat-guru dropdown
        document.getElementById('riwayat-jenis-penilaian').addEventListener('change', () => renderRiwayatGuruTable(currentUser));

        // NEW: Event listener for search inputs
        document.getElementById('admin-search-siswa-input').addEventListener('keyup', () => {
            currentPage = 1; // Reset to first page on search
            renderSiswaTable();
        });

        document.getElementById('guru-search-siswa-input').addEventListener('keyup', () => {
            if (currentUser) {
                const currentPengajar = pengajarData.find(p => p.nama === currentUser.nama);
                if (currentPengajar) {
                    renderGuruSiswaTable(currentPengajar.id);
                }
            }
        });

    });

     function handleStudentReportRequest(event) {
        event.preventDefault();
        const studentName = document.getElementById('public-student-search-input').value;
        const errorEl = document.getElementById('student-report-error');
        const siswa = getSiswaByNama(studentName);

        if (siswa) {
            errorEl.classList.add('hidden');
            showStudentReport(siswa);
        } else {
            errorEl.classList.remove('hidden');
        }
    }

    function showStudentReport(siswa) {
        document.getElementById('login-page').classList.add('hidden');
        document.getElementById('student-report-page').classList.remove('hidden');

        const titleEl = document.getElementById('public-report-title');
        const headEl = document.getElementById('public-report-table-head');
        const bodyEl = document.getElementById('public-report-table-body');
        
        titleEl.textContent = `${siswa.nama} - Kelas: ${siswa.kelas_reguler}/${siswa.kelas_tahfizh}`;
        
        // --- MODIFIED: Sort data by newest first ---
        const allSiswaData = penilaianData
            .filter(p => p.siswa_id === siswa.id)
            .sort((a, b) => new Date(b.tanggal) - new Date(a.tanggal));

        // Get the 3 most recent *unique* dates
        const uniqueDates = [];
        allSiswaData.forEach(item => {
            const dateString = new Date(item.tanggal).toLocaleDateString('id-ID');
            if (!uniqueDates.includes(dateString)) {
                uniqueDates.push(dateString);
            }
        });
        const lastThreeDates = uniqueDates.slice(0, 3);

        // Filter the data to include only records from those 3 dates
        const dataToRender = allSiswaData.filter(item => {
            const itemDateString = new Date(item.tanggal).toLocaleDateString('id-ID');
            return lastThreeDates.includes(itemDateString);
        });
        // --- END MODIFICATION ---


        headEl.innerHTML = `<tr>
            <th class="p-3">Tanggal</th><th class="p-3">Jenis</th><th class="p-3">Detail</th>
            <th class="p-3">Hasil</th><th class="p-3">Catatan</th><th class="p-3">Dinilai oleh</th>
        </tr>`;
        
        bodyEl.innerHTML = '';

        if(dataToRender.length === 0){
             bodyEl.innerHTML = `<tr><td colspan="6" class="p-3 text-center text-gray-500">Belum ada data penilaian.</td></tr>`;
        } else {
            dataToRender.forEach(item => {
                const pengajar = pengajarData.find(p => p.id === item.penilai_id) || {};
                let detailText = '';
                if(item.jenis_penilaian === 'Iqro') {
                    detailText = `Jilid ${item.jilid || '-'}, Hal ${item.halaman || '-'}`;
                    if(item.baris_dari) detailText += `, Baris ${item.baris_dari}-${item.baris_sampai || ''}`;
                } else {
                    detailText = `${item.surat || '-'} Ayat ${item.ayat_dari || '-'}-${item.ayat_sampai || '-'}`;
                }
                const newRow = bodyEl.insertRow();
                newRow.className = 'border-b';
                newRow.innerHTML = `
                    <td class="p-3">${new Date(item.tanggal).toLocaleString('id-ID', { dateStyle: 'medium', timeStyle: 'short' })}</td>
                    <td class="p-3">${item.jenis_penilaian}</td>
                    <td class="p-3">${detailText}</td>
                    <td class="p-3">${item.hasil}</td>
                    <td class="p-3">${item.catatan || '-'}</td>
                    <td class="p-3">${pengajar.nama || 'N/A'}</td>
                `;
            });
        }
    }

    function hideStudentReport() {
        document.getElementById('student-report-page').classList.add('hidden');
        document.getElementById('login-page').classList.remove('hidden');
    }
    
    // --- PRINT FUNCTION ---
    window.printReport = function() {
        const printHeader = document.querySelector('.print-header');
        printHeader.classList.remove('hidden');
        window.print();
        printHeader.classList.add('hidden');
    }

</script>

</body>
</html>
