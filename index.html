<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>SITYA - Sistem Informasi Tahfizh Yapanza</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" type="image/png" href="https://i.ibb.co/LzHmvdqc/LOGO-MI-YAPANZA-FIX.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- SweetAlert2 for notifications only -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- jsPDF for PDF Generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <!-- Supabase JS v2 -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8f9fa; }
        .sidebar { transition: transform 0.3s ease-in-out; }
        .main-content { transition: margin-left 0.3s ease-in-out; }
        .sidebar-hidden { transform: translateX(-100%); }
        .modal-backdrop { background-color: rgba(0,0,0,0.5); }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius:4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        @media print {
            body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; }
            #print-area { position: absolute; left:0; top:0; width:100%; }
            .no-print { display: none; }
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="app-container" class="hidden">
        <!-- Sidebar -->
        <aside id="sidebar" class="sidebar bg-gradient-to-b from-emerald-800 to-teal-900 text-white w-64 fixed h-full z-20 md:translate-x-0 -translate-x-full flex flex-col">
            <div class="p-6 flex items-center space-x-4">
                <div class="bg-white rounded-full flex-shrink-0">
                    <img src="https://i.ibb.co/LzHmvdqc/LOGO-MI-YAPANZA-FIX.png" alt="Logo Sekolah" class="h-12 w-12 object-cover rounded-full">
                </div>
                <div>
                    <h1 class="text-xl font-bold">SITYA</h1>
                    <p class="text-xs text-emerald-200">MI Pondok Yapanza</p>
                </div>
            </div>

            <nav id="admin-guru-nav" class="mt-4 flex-grow overflow-y-auto">
                <a href="#" class="nav-link block py-3 px-6 hover:bg-emerald-700 bg-emerald-700" data-page="dashboard">
                    <i class="fas fa-tachometer-alt mr-3 w-5"></i> Dashboard
                </a>
                <a href="#" class="nav-link block py-3 px-6 hover:bg-emerald-700" data-page="kelas">
                    <i class="fas fa-school mr-3 w-5"></i> Data Kelas
                </a>
                <a href="#" class="nav-link block py-3 px-6 hover:bg-emerald-700" data-page="pengajar">
                    <i class="fas fa-chalkboard-teacher mr-3 w-5"></i> Data Pengajar
                </a>
                <a href="#" class="nav-link block py-3 px-6 hover:bg-emerald-700" data-page="siswa">
                    <i class="fas fa-user-graduate mr-3 w-5"></i> Data Siswa
                </a>
                <a href="#" class="nav-link block py-3 px-6 hover:bg-emerald-700" data-page="penilaian">
                    <i class="fas fa-edit mr-3 w-5"></i> Input Penilaian
                </a>
                <a href="#" class="nav-link block py-3 px-6 hover:bg-emerald-700" data-page="rekap">
                    <i class="fas fa-print mr-3 w-5"></i> Rekap & Cetak
                </a>
                <a href="#" id="nav-pengguna" class="nav-link block py-3 px-6 hover:bg-emerald-700" data-page="pengguna">
                    <i class="fas fa-users-cog mr-3 w-5"></i> Kelola Pengguna
                </a>
            </nav>

            <nav id="siswa-nav" class="mt-4 flex-grow overflow-y-auto" style="display:none;">
                <a href="#" class="nav-link block py-3 px-6 hover:bg-emerald-700" data-page="profil">
                    <i class="fas fa-user-circle mr-3 w-5"></i> Profil Siswa
                </a>
                <a href="#" class="nav-link block py-3 px-6 hover:bg-emerald-700" data-page="pencapaian">
                    <i class="fas fa-trophy mr-3 w-5"></i> Pencapaian
                </a>
            </nav>

            <div class="p-2 border-t border-emerald-700">
                <a href="#" id="logout-button" class="nav-link block py-3 px-6 hover:bg-emerald-700 rounded-md" data-page="logout">
                    <i class="fas fa-sign-out-alt mr-3 w-5"></i> Keluar
                </a>
            </div>
        </aside>

        <!-- Main Content -->
        <main id="main-content" class="main-content md:ml-64 p-4 md:p-8">
            <header class="flex justify-between items-center mb-6 no-print">
                <div>
                    <button id="sidebar-toggle" class="md:hidden text-gray-600">
                        <i class="fas fa-bars fa-lg"></i>
                    </button>
                    <h2 id="page-title" class="text-2xl md:text-3xl font-bold text-gray-800">Dashboard</h2>
                </div>
                <div class="flex items-center space-x-4">
                    <p class="text-sm text-gray-600 hidden md:block">Selamat datang, <span id="user-name-display" class="font-semibold"></span></p>
                    <div class="w-10 h-10 bg-emerald-700 rounded-full flex items-center justify-center text-white font-bold" id="user-initials"></div>
                </div>
            </header>

            <div id="page-content"></div>
        </main>
    </div>

    <!-- Login Page -->
    <div id="login-page" class="flex items-center justify-center min-h-screen bg-gradient-to-br from-emerald-800 to-teal-900">
        <div class="w-full max-w-md p-8 space-y-8 bg-white rounded-2xl shadow-2xl">
            <div class="text-center">
                <div class="inline-block bg-white rounded-full mb-4 shadow-md">
                    <img src="https://i.ibb.co/LzHmvdqc/LOGO-MI-YAPANZA-FIX.png" alt="Logo Sekolah" class="h-16 w-16 object-cover rounded-full">
                </div>
                <h2 class="text-3xl font-extrabold text-gray-900">SITYA</h2>
                <p class="mt-1 text-sm text-gray-600">Sistem Informasi Tahfizh Yapanza</p>
                <p class="mt-4 text-sm text-gray-500">Silakan masuk untuk melanjutkan</p>
            </div>
            <form id="login-form" class="mt-8 space-y-6">
                <div class="rounded-md shadow-sm -space-y-px">
                    <div>
                        <label for="username" class="sr-only">Username</label>
                        <input id="username" name="username" type="text" required class="appearance-none rounded-none relative block w-full px-3 py-3 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-t-md focus:outline-none focus:ring-emerald-500 focus:border-emerald-500 focus:z-10 sm:text-sm" placeholder="Username (admin, guru, atau siswa)">
                    </div>
                    <div>
                        <label for="password" class="sr-only">Password</label>
                        <input id="password" name="password" type="password" required class="appearance-none rounded-none relative block w-full px-3 py-3 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-b-md focus:outline-none focus:ring-emerald-500 focus:border-emerald-500 focus:z-10 sm:text-sm" placeholder="Password (coba: 123)">
                    </div>
                </div>
                <p id="login-error" class="text-red-500 text-sm hidden">Username atau password salah.</p>
                <div>
                    <button type="submit" class="group relative w-full flex justify-center py-3 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-emerald-600 hover:bg-emerald-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-emerald-500">
                        Masuk
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Template -->
    <div id="modal" class="fixed inset-0 z-50 items-center justify-center hidden">
        <div class="modal-backdrop fixed inset-0"></div>
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg m-4 z-10 flex flex-col max-h-[90vh]">
            <div class="p-4 border-b flex justify-between items-center flex-shrink-0">
                <h3 id="modal-title" class="text-lg font-semibold"></h3>
                <button id="modal-close" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>
            <div id="modal-body" class="p-6 overflow-y-auto"></div>
        </div>
    </div>

<script type="module">
/* ===========================================================
   Supabase setup & helper functions
   =========================================================== */
const SUPABASE_URL = "https://ipzsytmlbdnlwtdxbfgx.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlwenN5dG1sYmRubHd0ZHhiZmd4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMTcwNjQsImV4cCI6MjA3MzU5MzA2NH0.3dd66rBy4uCL6w7x2C-Mp3I-V82OGlb2cLLPH-zPlfs";

const supabase = supabaseJs.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// Local app state (keperluan UI dan cache)
const state = {
    currentUser: null,
    currentPage: 'dashboard',
    data: {
        users: [],
        pengajar: [],
        kelasReguler: [],
        kelasTahfizh: [],
        siswa: [],
        penilaian: []
    }
};

const surahList = ["Al-Fatihah", "Al-Baqarah", "Ali 'Imran", "An-Nisa'", "Al-Ma'idah", "Al-An'am", "Al-A'raf", "Al-Anfal", "At-Tawbah", "Yunus", "Hud", "Yusuf", "Ar-Ra'd", "Ibrahim", "Al-Hijr", "An-Nahl", "Al-Isra'", "Al-Kahf", "Maryam", "Taha", "Al-Anbiya'", "Al-Hajj", "Al-Mu'minun", "An-Nur", "Al-Furqan", "Ash-Shu'ara'", "An-Naml", "Al-Qasas", "Al-'Ankabut", "Ar-Rum", "Luqman", "As-Sajdah", "Al-Ahzab", "Saba'", "Fatir", "Ya-Sin", "As-Saffat", "Sad", "Az-Zumar", "Ghafir", "Fussilat", "Ash-Shura", "Az-Zukhruf", "Ad-Dukhan", "Al-Jathiyah", "Al-Ahqaf", "Muhammad", "Al-Fath", "Al-Hujurat", "Qaf", "Adh-Dhariyat", "At-Tur", "An-Najm", "Al-Qamar", "Ar-Rahman", "Al-Waqi'ah", "Al-Hadid", "Al-Mujadilah", "Al-Hashr", "Al-Mumtahanah", "As-Saff", "Al-Jumu'ah", "Al-Munafiqun", "At-Taghabun", "At-Talaq", "At-Tahrim", "Al-Mulk", "Al-Qalam", "Al-Haqqah", "Al-Ma'arij", "Nuh", "Al-Jinn", "Al-Muzzammil", "Al-Muddaththir", "Al-Qiyamah", "Al-Insan", "Al-Mursalat", "An-Naba'", "An-Nazi'at", "'Abasa", "At-Takwir", "Al-Infitar", "Al-Mutaffifin", "Al-Inshiqaq", "Al-Buruj", "At-Tariq", "Al-A'la", "Al-Ghashiyah", "Al-Fajr", "Al-Balad", "Ash-Shams", "Al-Layl", "Ad-Duha", "Ash-Sharh", "At-Tin", "Al-'Alaq", "Al-Qadr", "Al-Bayyinah", "Az-Zalzalah", "Al-'Adiyat", "Al-Qari'ah", "At-Takathur", "Al-'Asr", "Al-Humazah", "Al-Fil", "Quraysh", "Al-Ma'un", "Al-Kawthar", "Al-Kafirun", "An-Nasr", "Al-Masad", "Al-Ikhlas", "Al-Falaq", "An-Nas"];

/* Toast */
const Toast = Swal.mixin({
  toast: true,
  position: 'top-end',
  showConfirmButton: false,
  timer: 3000,
  timerProgressBar: true,
  didOpen: (toast) => {
    toast.addEventListener('mouseenter', Swal.stopTimer)
    toast.addEventListener('mouseleave', Swal.resumeTimer)
  }
});

/* Utility: format timestamp */
const formatTimestamp = (isoString) => {
    if(!isoString) return '-';
    const date = new Date(isoString);
    return date.toLocaleString('id-ID', {
        day: '2-digit', month: 'long', year: 'numeric', hour: '2-digit', minute: '2-digit'
    }) + ' WIB';
};

/* ===========================================================
   CRUD helpers (Supabase)
   =========================================================== */
async function fetchTable(table, select = '*', orderBy = null) {
    try {
        let q = supabase.from(table).select(select);
        if (orderBy) q = q.order(orderBy.column, { ascending: orderBy.ascending });
        const { data, error } = await q;
        if (error) throw error;
        return data || [];
    } catch (err) {
        console.error(`fetchTable ${table} error:`, err);
        Toast.fire({ icon: 'error', title: `Gagal ambil ${table}` });
        return [];
    }
}

async function insertRow(table, row) {
    try {
        const { data, error } = await supabase.from(table).insert([row]).select();
        if (error) throw error;
        return data?.[0] || null;
    } catch (err) {
        console.error(`insert ${table} error:`, err);
        Toast.fire({ icon: 'error', title: `Gagal menyimpan ke ${table}` });
        return null;
    }
}

async function updateRow(table, id, row, idCol = 'id') {
    try {
        const { data, error } = await supabase.from(table).update(row).eq(idCol, id).select();
        if (error) throw error;
        return data?.[0] || null;
    } catch (err) {
        console.error(`update ${table} error:`, err);
        Toast.fire({ icon: 'error', title: `Gagal update ${table}` });
        return null;
    }
}

async function deleteRow(table, id, idCol = 'id') {
    try {
        const { error } = await supabase.from(table).delete().eq(idCol, id);
        if (error) throw error;
        return true;
    } catch (err) {
        console.error(`delete ${table} error:`, err);
        Toast.fire({ icon: 'error', title: `Gagal menghapus dari ${table}` });
        return false;
    }
}

/* Load all data from Supabase into state.data */
async function loadAllData() {
    // fetch in parallel
    const [users, pengajar, kelasReguler, kelasTahfizh, siswa, penilaian] = await Promise.all([
        fetchTable('users'),
        fetchTable('pengajar'),
        fetchTable('kelas_reguler'),
        fetchTable('kelas_tahfizh'),
        fetchTable('siswa'),
        fetchTable('penilaian')
    ]);
    // Map to local names used by app
    state.data.users = users || [];
    state.data.pengajar = pengajar || [];
    state.data.kelasReguler = kelasReguler || [];
    state.data.kelasTahfizh = kelasTahfizh || [];
    state.data.siswa = siswa || [];
    state.data.penilaian = penilaian || [];
}

/* ===========================================================
   App init & login
   =========================================================== */
document.addEventListener('DOMContentLoaded', async () => {
    const loggedInUser = sessionStorage.getItem('currentUser');
    if (loggedInUser) {
        state.currentUser = JSON.parse(loggedInUser);
        await initializeApp();
    } else {
        document.getElementById('login-page').classList.remove('hidden');
        document.getElementById('login-page').classList.add('flex');
    }
});

async function initializeApp() {
    // Load data from Supabase
    await loadAllData();
    bindGlobalUIEvents();
    setupNavHandlers();
    renderPage(state.currentPage || 'dashboard');
    // Show app container and hide login
    document.getElementById('login-page').classList.add('hidden');
    document.getElementById('app-container').classList.remove('hidden');
    document.getElementById('app-container').classList.add('block');

    // Put user name & initials
    if (state.currentUser) {
        document.getElementById('user-name-display').textContent = state.currentUser.name || state.currentUser.username;
        const initialsEl = document.getElementById('user-initials');
        const initials = (state.currentUser.initials) ? state.currentUser.initials : (state.currentUser.name || state.currentUser.username).split(' ').map(s=>s[0]).slice(0,2).join('').toUpperCase();
        initialsEl.textContent = initials;
        // show/hide nav depending on role
        if (state.currentUser.role && state.currentUser.role.toLowerCase() === 'siswa') {
            document.getElementById('admin-guru-nav').style.display = 'none';
            document.getElementById('siswa-nav').style.display = 'block';
        } else {
            document.getElementById('admin-guru-nav').style.display = 'block';
            document.getElementById('siswa-nav').style.display = 'none';
        }
    }
}

/* Login form */
document.getElementById('login-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const username = document.getElementById('username').value.trim();
    const password = document.getElementById('password').value.trim();
    // Query supabase users table (assumes plaintext password column named `password`)
    try {
        const { data, error } = await supabase.from('users').select('*').eq('username', username).limit(1);
        if (error) throw error;
        if (data.length === 0 || data[0].password !== password) {
            document.getElementById('login-error').classList.remove('hidden');
            return;
        }
        const user = data[0];
        state.currentUser = user;
        sessionStorage.setItem('currentUser', JSON.stringify(user));
        await initializeApp();
        Toast.fire({ icon: 'success', title: 'Berhasil masuk' });
    } catch (err) {
        console.error(err);
        Swal.fire('Error', 'Terjadi kesalahan saat login. Cek konsol.', 'error');
    }
});

/* Logout */
document.getElementById('logout-button').addEventListener('click', (e) => {
    e.preventDefault();
    sessionStorage.removeItem('currentUser');
    state.currentUser = null;
    location.reload();
});

/* ===========================================================
   UI helpers & modal
   =========================================================== */
const pageTitle = document.getElementById('page-title');
const pageContent = document.getElementById('page-content');

function showModal(title, bodyHtml) {
    document.getElementById('modal-title').textContent = title;
    document.getElementById('modal-body').innerHTML = bodyHtml;
    const modal = document.getElementById('modal');
    modal.classList.remove('hidden');
    modal.classList.add('flex');
    document.getElementById('modal-close').addEventListener('click', closeModal);
}

function closeModal() {
    const modal = document.getElementById('modal');
    modal.classList.add('hidden');
    modal.classList.remove('flex');
    document.getElementById('modal-body').innerHTML = '';
}

/* Confirm delete helper */
function confirmDelete(id, callback) {
    Swal.fire({
        title: 'Yakin ingin menghapus?',
        text: "Data akan terhapus permanen!",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Ya, hapus',
        cancelButtonText: 'Batal'
    }).then((result) => {
        if (result.isConfirmed) callback(id);
    });
}

/* ===========================================================
   Page routing & render functions (re-uses your original renderers but bind to state.data)
   =========================================================== */
function setupNavHandlers() {
    document.querySelectorAll('.nav-link').forEach(link => {
        link.addEventListener('click', (e) => {
            e.preventDefault();
            const p = link.dataset.page;
            if (p === 'logout') {
                document.getElementById('logout-button').click();
                return;
            }
            renderPage(p);
        });
    });
    document.getElementById('sidebar-toggle').addEventListener('click', () => {
        const sb = document.getElementById('sidebar');
        if (sb.classList.contains('-translate-x-full')) {
            sb.classList.remove('-translate-x-full');
        } else {
            sb.classList.add('-translate-x-full');
        }
    });
}

function renderPage(pageName) {
    state.currentPage = pageName;
    pageContent.innerHTML = '';

    document.querySelectorAll('.nav-link').forEach(link => {
        link.classList.remove('bg-emerald-700');
        if (link.dataset.page === pageName) link.classList.add('bg-emerald-700');
    });

    switch (pageName) {
        case 'dashboard': pageTitle.textContent = 'Dashboard'; renderDashboard(); break;
        case 'kelas': pageTitle.textContent = 'Data Kelas'; renderKelas(); break;
        case 'pengajar': pageTitle.textContent = 'Data Pengajar'; renderPengajar(); break;
        case 'siswa': pageTitle.textContent = 'Data Siswa'; renderSiswa(); break;
        case 'penilaian': pageTitle.textContent = 'Input Penilaian'; renderPenilaian(); break;
        case 'rekap': pageTitle.textContent = 'Rekapitulasi & Cetak Laporan'; renderRekap(); break;
        case 'pengguna': pageTitle.textContent = 'Manajemen Pengguna'; renderPengguna(); break;
        case 'profil': pageTitle.textContent = 'Profil Siswa'; renderProfil(); break;
        case 'pencapaian': pageTitle.textContent = 'Pencapaian Hafalan'; renderPencapaian(); break;
        default: pageTitle.textContent = 'Dashboard'; renderDashboard(); break;
    }
}

/* Dashboard (uses state.data) */
function renderDashboard() {
    const { siswa, pengajar, kelasTahfizh } = state.data;
    const tahfizhStats = state.data.kelasTahfizh.map(kelas => {
        const studentCount = siswa.filter(s => s.class_reguler_id ? s.class_tahfizh_id === kelas.id : s.classTahfizhId === kelas.id).length;
        return { name: kelas.name, count: studentCount };
    });

    // icons mapping (kept)
    const icons = {
        'Iqro': { icon: 'fa-book-open', color: 'emerald' },
        'Ibtida': { icon: 'fa-child-reaching', color: 'teal' },
        'Wustho': { icon: 'fa-user-graduate', color: 'sky' },
        'Ulya': { icon: 'fa-star', color: 'indigo' }
    };

    pageContent.innerHTML = `
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <div class="bg-white p-6 rounded-xl shadow-lg flex items-center justify-between transition-transform transform hover:scale-105">
                <div>
                    <p class="text-sm font-medium text-gray-500">Total Siswa</p>
                    <p class="text-4xl font-bold text-gray-800">${state.data.siswa.length}</p>
                </div>
                <div class="bg-blue-100 p-4 rounded-full">
                    <i class="fas fa-users text-3xl text-blue-600"></i>
                </div>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-lg flex items-center justify-between transition-transform transform hover:scale-105">
                <div>
                    <p class="text-sm font-medium text-gray-500">Total Pengajar</p>
                    <p class="text-4xl font-bold text-gray-800">${state.data.pengajar.length}</p>
                </div>
                <div class="bg-green-100 p-4 rounded-full">
                    <i class="fas fa-chalkboard-teacher text-3xl text-green-600"></i>
                </div>
            </div>

            ${tahfizhStats.map(stat => `
            <div class="bg-white p-6 rounded-xl shadow-lg flex items-center justify-between transition-transform transform hover:scale-105">
                <div>
                    <p class="text-sm font-medium text-gray-500">Siswa ${stat.name}</p>
                    <p class="text-4xl font-bold text-gray-800">${stat.count}</p>
                </div>
                <div class="bg-emerald-100 p-4 rounded-full">
                    <i class="fas fa-star text-3xl text-emerald-600"></i>
                </div>
            </div>`).join('')}
        </div>
        <div class="mt-8 bg-white p-6 rounded-lg shadow-md">
            <h3 class="text-xl font-semibold mb-4 text-gray-700">Aktivitas Terbaru</h3>
            <div id="dashboard-latest-activity"></div>
        </div>
    `;
    renderLatestActivity('dashboard-latest-activity');
}

/* Latest activity renderer */
function renderLatestActivity(containerId) {
    const container = document.getElementById(containerId);
    if (!container) return;
    const latest = [...state.data.penilaian].sort((a,b)=> new Date(b.timestamp) - new Date(a.timestamp)).slice(0,5);
    if (latest.length === 0) {
        container.innerHTML = '<div class="text-gray-500 text-center py-8">Belum ada aktivitas penilaian.</div>';
        return;
    }
    container.innerHTML = latest.map(p => {
        const student = state.data.siswa.find(s => s.id === p.student_id || s.id === p.studentId);
        const assessor = state.data.pengajar.find(t => t.id === p.assessed_by_id || t.id === p.assessedById);
        const statusColor = { 'Lancar/Pindah': 'text-emerald-600', 'Kurang Lancar': 'text-yellow-600', 'Mengulang': 'text-red-600' };
        let detailText = '';
        if (p.type === 'Iqro' || (p.detail && p.detail.jilid)) {
            detailText = `Jilid ${p.detail.jilid}, Hal ${p.detail.halaman}, Baris ${p.detail.from_baris}-${p.detail.to_baris}`;
        } else {
            detailText = `${p.detail?.surah || '-'} ${p.detail?.from || '-'}-${p.detail?.to || '-'}`;
        }
        return `
            <div class="p-4 border border-gray-200 rounded-lg space-y-1">
                <p class="font-bold text-gray-800">${student ? student.name : 'Siswa Dihapus'}</p>
                <p class="text-sm text-gray-700"><span class="font-semibold">${p.type}</span>: ${detailText} - <span class="font-bold ${statusColor[p.status] || ''}">${p.status}</span></p>
                <p class="text-xs text-gray-500">Dinilai oleh: ${assessor ? assessor.name : 'N/A'}</p>
                <p class="text-xs text-gray-400 text-right"><i class="far fa-clock mr-1"></i>${formatTimestamp(p.timestamp)}</p>
            </div>
        `;
    }).join('');
}

/* ===========================================================
   Generic CRUD listeners (updated to call Supabase)
   =========================================================== */
function attachCrudEventListeners(entityName, renderFunction, openModalFunction, tableId) {
    // Only attach add/edit/delete if current user is Admin
    const isAdmin = state.currentUser && state.currentUser.role && state.currentUser.role.toLowerCase() === 'admin';
    if (!isAdmin) return;

    const addBtn = document.getElementById(`add-${tableId}-btn`);
    if (addBtn) addBtn.addEventListener('click', () => openModalFunction());

    const tableBody = document.getElementById(`${tableId}-table-body`);
    if (!tableBody) return;

    tableBody.addEventListener('click', async (e) => {
        const editButton = e.target.closest('.edit-btn');
        const deleteButton = e.target.closest('.delete-btn');

        if (editButton) {
            const id = parseInt(editButton.dataset.id);
            const item = state.data[entityName].find(i => i.id === id);
            if (item) openModalFunction(item);
        }

        if (deleteButton) {
            const id = parseInt(deleteButton.dataset.id);
            confirmDelete(id, async (confirmedId) => {
                // Special checks (same as original)
                if (entityName === 'users') {
                    const userToDelete = state.data.users.find(u => u.id === confirmedId);
                    if (userToDelete && userToDelete.role === 'Guru') {
                        const isLinked = state.data.siswa.some(s => s.teacher_id === userToDelete.linkedId || s.teacherId === userToDelete.linkedId);
                        if (isLinked) {
                            Swal.fire('Gagal!', 'Tidak dapat menghapus guru yang masih mengampu siswa.', 'error');
                            return;
                        }
                    }
                }
                // Call delete
                const tableMap = {
                    users: 'users',
                    pengajar: 'pengajar',
                    kelasReguler: 'kelas_reguler',
                    kelasTahfizh: 'kelas_tahfizh',
                    siswa: 'siswa',
                    penilaian: 'penilaian'
                };
                const table = tableMap[entityName];
                const ok = await deleteRow(table, confirmedId);
                if (ok) {
                    await loadAllData();
                    renderFunction();
                    Toast.fire({ icon: 'success', title: 'Data berhasil dihapus!' });
                }
            });
        }
    });
}

/* ===========================================================
   KELAS: render and modal (Reguler & Tahfizh)
   =========================================================== */
function renderKelas() {
    const isAdmin = state.currentUser.role === 'Admin' || (state.currentUser.role && state.currentUser.role.toLowerCase() === 'admin');
    pageContent.innerHTML = `
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <div class="bg-white p-6 rounded-lg shadow-md">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold text-gray-700">Kelas Reguler</h3>
                    ${isAdmin ? `<button id="add-kelasReguler-btn" class="bg-emerald-600 text-white px-4 py-2 rounded-lg hover:bg-emerald-700"><i class="fas fa-plus mr-2"></i>Tambah</button>` : ''}
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="py-2 px-4 text-left text-xs font-medium text-gray-500 uppercase">Nama Kelas</th>
                                ${isAdmin ? `<th class="py-2 px-4 text-left text-xs font-medium text-gray-500 uppercase">Aksi</th>` : ''}
                            </tr>
                        </thead>
                        <tbody id="kelasReguler-table-body">
                            ${state.data.kelasReguler.map(k => `
                                <tr class="border-b">
                                    <td class="py-3 px-4">Kelas ${k.name}</td>
                                    ${isAdmin ? `<td class="py-3 px-4 space-x-2"><button class="edit-btn text-blue-500" data-id="${k.id}"><i class="fas fa-edit"></i></button><button class="delete-btn text-red-500" data-id="${k.id}"><i class="fas fa-trash"></i></button></td>` : ''}
                                </tr>`).join('')}
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="bg-white p-6 rounded-lg shadow-md">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold text-gray-700">Kelas Tahfizh</h3>
                    ${isAdmin ? `<button id="add-kelasTahfizh-btn" class="bg-teal-600 text-white px-4 py-2 rounded-lg hover:bg-teal-700"><i class="fas fa-plus mr-2"></i>Tambah</button>` : ''}
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="py-2 px-4 text-left text-xs font-medium text-gray-500 uppercase">Nama Kelas</th>
                                ${isAdmin ? `<th class="py-2 px-4 text-left text-xs font-medium text-gray-500 uppercase">Aksi</th>` : ''}
                            </tr>
                        </thead>
                        <tbody id="kelasTahfizh-table-body">
                            ${state.data.kelasTahfizh.map(k => `
                                <tr class="border-b">
                                    <td class="py-3 px-4">${k.name}</td>
                                    ${isAdmin ? `<td class="py-3 px-4 space-x-2"><button class="edit-btn text-blue-500" data-id="${k.id}"><i class="fas fa-edit"></i></button><button class="delete-btn text-red-500" data-id="${k.id}"><i class="fas fa-trash"></i></button></td>` : ''}
                                </tr>`).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    `;
    attachCrudEventListeners('kelasReguler', renderKelas, (item) => openKelasModal('Reguler', item), 'kelasReguler');
    attachCrudEventListeners('kelasTahfizh', renderKelas, (item) => openKelasModal('Tahfizh', item), 'kelasTahfizh');
}

function openKelasModal(type, kelas = null) {
    const entityTable = (type === 'Reguler') ? 'kelas_reguler' : 'kelas_tahfizh';
    const modalBody = `
        <form id="kelas-form" class="space-y-4">
            <input type="hidden" id="kelasId" value="${kelas ? kelas.id : ''}">
            <div>
                <label class="block text-gray-700 text-sm font-bold mb-2" for="name">Nama Kelas</label>
                <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" id="name" type="text" value="${kelas ? kelas.name : ''}" required>
            </div>
            <div class="flex justify-end pt-2">
                <button type="submit" class="bg-emerald-600 text-white px-4 py-2 rounded-lg hover:bg-emerald-700">${kelas ? 'Update' : 'Simpan'}</button>
            </div>
        </form>
    `;
    showModal(`${kelas ? 'Edit' : 'Tambah'} Kelas ${type}`, modalBody);

    document.getElementById('kelas-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = document.getElementById('kelasId').value;
        const name = document.getElementById('name').value.trim();
        if (!name) { Toast.fire({ icon: 'warning', title: 'Nama kelas kosong' }); return; }
        if (id) {
            await updateRow(entityTable, parseInt(id), { name });
        } else {
            await insertRow(entityTable, { name });
        }
        closeModal();
        await loadAllData();
        renderKelas();
        Toast.fire({ icon: 'success', title: 'Data kelas berhasil disimpan!' });
    }, { once: true });
}

/* ===========================================================
   PENGAJAR
   =========================================================== */
function renderPengajarTableBody(pengajarList) {
    const isAdmin = state.currentUser.role === 'Admin' || (state.currentUser.role && state.currentUser.role.toLowerCase() === 'admin');
    const tableBody = document.getElementById('pengajar-table-body');
    if (!tableBody) return;

    tableBody.innerHTML = pengajarList.map(p => {
        const studentCount = state.data.siswa.filter(s => s.teacher_id === p.id || s.teacherId === p.id).length;
        return `
            <tr class="border-b">
                <td class="py-3 px-4 whitespace-nowrap font-medium">${p.name}</td>
                <td class="py-3 px-4 whitespace-nowrap">${studentCount} Siswa</td>
                <td class="py-3 px-4 whitespace-nowrap">${p.phone || ''}</td>
                ${isAdmin ? `<td class="py-3 px-4 whitespace-nowrap space-x-2"><button class="edit-btn text-blue-500 hover:text-blue-700" data-id="${p.id}"><i class="fas fa-edit"></i></button><button class="delete-btn text-red-500 hover:text-red-700" data-id="${p.id}"><i class="fas fa-trash"></i></button></td>` : ''}
            </tr>
        `;
    }).join('');

    if (pengajarList.length === 0) {
        tableBody.innerHTML = `<tr><td colspan="${isAdmin ? 4 : 3}" class="text-center py-4">Tidak ada data pengajar yang cocok.</td></tr>`;
    }
}

function renderPengajar() {
    const isAdmin = state.currentUser.role === 'Admin' || (state.currentUser.role && state.currentUser.role.toLowerCase() === 'admin');
    pageContent.innerHTML = `
        <div class="bg-white p-6 rounded-lg shadow-md">
            <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
                <h3 class="text-xl font-semibold text-gray-700">Daftar Pengajar</h3>
                <div class="w-full md:w-1/3">
                    <input type="text" id="search-pengajar" placeholder="Cari nama pengajar..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500">
                </div>
                ${isAdmin ? `<button id="add-pengajar-btn" class="bg-emerald-600 text-white px-4 py-2 rounded-lg hover:bg-emerald-700 transition w-full md:w-auto"><i class="fas fa-plus mr-2"></i>Tambah Pengajar</button>` : ''}
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full bg-white">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="py-2 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama</th>
                            <th class="py-2 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Siswa Diampu</th>
                            <th class="py-2 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kontak</th>
                            ${isAdmin ? `<th class="py-2 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>` : ''}
                        </tr>
                    </thead>
                    <tbody id="pengajar-table-body"></tbody>
                </table>
            </div>
        </div>
    `;
    document.getElementById('search-pengajar').addEventListener('input', (e) => {
        const searchTerm = e.target.value.toLowerCase();
        const filteredData = state.data.pengajar.filter(p => p.name.toLowerCase().includes(searchTerm));
        renderPengajarTableBody(filteredData);
    });
    renderPengajarTableBody(state.data.pengajar || []);
    attachCrudEventListeners('pengajar', renderPengajar, openPengajarModal, 'pengajar');
}

function openPengajarModal(pengajar = null) {
    const modalBody = `
        <form id="pengajar-form" class="space-y-4">
            <input type="hidden" id="pengajarId" value="${pengajar ? pengajar.id : ''}">
            <div>
                <label class="block text-gray-700 text-sm font-bold mb-2" for="name">Nama Lengkap</label>
                <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700" id="name" type="text" value="${pengajar ? pengajar.name : ''}" required>
            </div>
            <div>
                <label class="block text-gray-700 text-sm font-bold mb-2" for="nip">NIP (Opsional)</label>
                <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700" id="nip" type="text" value="${pengajar ? pengajar.nip || '' : ''}">
            </div>
            <div>
                <label class="block text-gray-700 text-sm font-bold mb-2" for="phone">No. Telepon</label>
                <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700" id="phone" type="tel" value="${pengajar ? pengajar.phone || '' : ''}" required>
            </div>
            <div class="flex justify-end pt-2">
                <button type="submit" class="bg-emerald-600 text-white px-4 py-2 rounded-lg hover:bg-emerald-700">${pengajar ? 'Update' : 'Simpan'}</button>
            </div>
        </form>
    `;
    showModal(pengajar ? 'Edit Pengajar' : 'Tambah Pengajar', modalBody);

    document.getElementById('pengajar-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = document.getElementById('pengajarId').value;
        const newPengajar = {
            name: document.getElementById('name').value.trim(),
            nip: document.getElementById('nip').value.trim(),
            phone: document.getElementById('phone').value.trim()
        };
        if (id) {
            await updateRow('pengajar', parseInt(id), newPengajar);
        } else {
            await insertRow('pengajar', newPengajar);
        }
        closeModal();
        await loadAllData();
        renderPengajar();
        Toast.fire({ icon: 'success', title: 'Data pengajar berhasil disimpan!' });
    }, { once: true });
}

/* ===========================================================
   SISWA
   =========================================================== */
function renderSiswa() {
    const isAdmin = state.currentUser.role === 'Admin' || (state.currentUser.role && state.currentUser.role.toLowerCase() === 'admin');
    const kelasRegulerOptions = state.data.kelasReguler.map(k => `<option value="${k.id}">Kelas ${k.name}</option>`).join('');
    const kelasTahfizhOptions = state.data.kelasTahfizh.map(k => `<option value="${k.id}">${k.name}</option>`).join('');
    const pengajarOptions = state.data.pengajar.map(p => `<option value="${p.id}">${p.name}</option>`).join('');

    pageContent.innerHTML = `
        <div class="bg-white p-6 rounded-lg shadow-md">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold text-gray-700">Daftar Siswa</h3>
                 ${isAdmin ? `<button id="add-siswa-btn" class="bg-emerald-600 text-white px-4 py-2 rounded-lg hover:bg-emerald-700 transition flex items-center shadow hover:shadow-lg"><i class="fas fa-plus mr-2"></i>Tambah Siswa</button>` : ''}
            </div>

            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                <input type="text" id="search-siswa" placeholder="Cari nama atau NISN..." class="md:col-span-2 w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500">
                <select id="filter-kelas-reguler" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500">
                    <option value="">Semua Kelas Reguler</option>
                    ${kelasRegulerOptions}
                </select>
                 <select id="filter-kelas-tahfizh" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500">
                    <option value="">Semua Kelas Tahfizh</option>
                    ${kelasTahfizhOptions}
                </select>
                <select id="filter-pengajar" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500 md:col-start-4">
                    <option value="">Semua Pengajar</option>
                    ${pengajarOptions}
                </select>
            </div>

            <div class="overflow-x-auto">
                <table class="min-w-full bg-white">
                     <thead class="bg-gray-100">
                        <tr>
                            <th class="py-3 px-6 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">NISN</th>
                            <th class="py-3 px-6 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Nama</th>
                            <th class="py-3 px-6 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Kelas</th>
                            <th class="py-3 px-6 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Pengajar</th>
                            ${isAdmin ? `<th class="py-3 px-6 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Aksi</th>` : ''}
                        </tr>
                    </thead>
                    <tbody id="siswa-table-body" class="divide-y divide-gray-200"></tbody>
                </table>
            </div>
        </div>
    `;

    document.getElementById('search-siswa').addEventListener('input', applySiswaFiltersAndRender);
    document.getElementById('filter-kelas-reguler').addEventListener('change', applySiswaFiltersAndRender);
    document.getElementById('filter-kelas-tahfizh').addEventListener('change', applySiswaFiltersAndRender);
    document.getElementById('filter-pengajar').addEventListener('change', applySiswaFiltersAndRender);

    applySiswaFiltersAndRender();
    attachCrudEventListeners('siswa', () => applySiswaFiltersAndRender(), openSiswaModal, 'siswa');
}

function applySiswaFiltersAndRender() {
    const searchTerm = document.getElementById('search-siswa').value.toLowerCase();
    const kelasRegulerId = document.getElementById('filter-kelas-reguler').value;
    const kelasTahfizhId = document.getElementById('filter-kelas-tahfizh').value;
    const pengajarId = document.getElementById('filter-pengajar').value;

    let filteredSiswa = state.data.siswa.filter(s => (s.name || '').toLowerCase().includes(searchTerm) || (s.nisn || '').includes(searchTerm));
    if (kelasRegulerId) filteredSiswa = filteredSiswa.filter(s => (s.class_reguler_id || s.classRegulerId) == kelasRegulerId);
    if (kelasTahfizhId) filteredSiswa = filteredSiswa.filter(s => (s.class_tahfizh_id || s.classTahfizhId) == kelasTahfizhId);
    if (pengajarId) filteredSiswa = filteredSiswa.filter(s => (s.teacher_id || s.teacherId) == pengajarId);
    renderSiswaTableBody(filteredSiswa);
}

function renderSiswaTableBody(siswaList) {
    const isAdmin = state.currentUser.role === 'Admin' || (state.currentUser.role && state.currentUser.role.toLowerCase() === 'admin');
    const tableBody = document.getElementById('siswa-table-body');
    if (!tableBody) return;

    tableBody.innerHTML = siswaList.map(s => {
        const kelasReguler = state.data.kelasReguler.find(k => k.id === (s.class_reguler_id || s.classRegulerId));
        const kelasTahfizh = state.data.kelasTahfizh.find(k => k.id === (s.class_tahfizh_id || s.classTahfizhId));
        const kelasDisplay = `${kelasReguler ? kelasReguler.name : 'N/A'} / ${kelasTahfizh ? kelasTahfizh.name : 'N/A'}`;
        const pengajar = state.data.pengajar.find(p => p.id === (s.teacher_id || s.teacherId));
        return `
            <tr class="hover:bg-gray-50">
                <td class="py-4 px-6 whitespace-nowrap text-sm font-medium text-gray-900">${s.nisn || ''}</td>
                <td class="py-4 px-6 whitespace-nowrap text-sm text-gray-800">${s.name || ''}</td>
                <td class="py-4 px-6 whitespace-nowrap text-sm text-gray-500">${kelasDisplay}</td>
                <td class="py-4 px-6 whitespace-nowrap text-sm text-gray-500">${pengajar ? pengajar.name : 'N/A'}</td>
                ${isAdmin ? `<td class="py-4 px-6 whitespace-nowrap space-x-4 text-sm font-medium"><button class="edit-btn text-blue-600 hover:text-blue-900" data-id="${s.id}"><i class="fas fa-edit mr-1"></i> Edit</button><button class="delete-btn text-red-600 hover:text-red-900" data-id="${s.id}"><i class="fas fa-trash mr-1"></i> Hapus</button></td>` : ''}
            </tr>
        `;
    }).join('');

    if (siswaList.length === 0) {
        tableBody.innerHTML = `<tr><td colspan="${isAdmin ? 5 : 4}" class="text-center py-4">Tidak ada data siswa yang cocok.</td></tr>`;
    }
}

function openSiswaModal(siswa = null) {
    const classRegulerOptions = state.data.kelasReguler.map(k => `<option value="${k.id}" ${siswa && (siswa.class_reguler_id || siswa.classRegulerId) === k.id ? 'selected' : ''}>Kelas ${k.name}</option>`).join('');
    const classTahfizhOptions = state.data.kelasTahfizh.map(k => `<option value="${k.id}" ${siswa && (siswa.class_tahfizh_id || siswa.classTahfizhId) === k.id ? 'selected' : ''}>${k.name}</option>`).join('');
    const teacherOptions = state.data.pengajar.map(p => `<option value="${p.id}" ${siswa && (siswa.teacher_id || siswa.teacherId) === p.id ? 'selected' : ''}>${p.name}</option>`).join('');

    const modalBody = `
        <form id="siswa-form" class="space-y-6">
            <input type="hidden" id="siswaId" value="${siswa ? siswa.id : ''}">
            <div>
                <label class="block text-gray-700 text-sm font-bold mb-2" for="nisn">NISN</label>
                <input class="shadow-sm appearance-none border rounded w-full py-3 px-4 text-gray-700" id="nisn" type="text" value="${siswa ? (siswa.nisn || '') : ''}" required placeholder="Nomor Induk Siswa Nasional">
            </div>
            <div>
                <label class="block text-gray-700 text-sm font-bold mb-2" for="name">Nama Lengkap</label>
                <input class="shadow-sm appearance-none border rounded w-full py-3 px-4 text-gray-700" id="name" type="text" value="${siswa ? (siswa.name || '') : ''}" required placeholder="Nama lengkap siswa">
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="classRegulerId">Kelas Reguler</label>
                    <select id="classRegulerId" class="shadow-sm appearance-none border rounded w-full py-3 px-4 text-gray-700" required>
                        <option value="">Pilih Kelas</option>
                        ${classRegulerOptions}
                    </select>
                </div>
                <div>
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="classTahfizhId">Kelas Tahfizh</label>
                    <select id="classTahfizhId" class="shadow-sm appearance-none border rounded w-full py-3 px-4 text-gray-700" required>
                        <option value="">Pilih Kelas</option>
                        ${classTahfizhOptions}
                    </select>
                </div>
            </div>
            <div>
                <label class="block text-gray-700 text-sm font-bold mb-2" for="teacherId">Pengajar</label>
                <select id="teacherId" class="shadow-sm appearance-none border rounded w-full py-3 px-4 text-gray-700" required>
                    <option value="">Pilih Pengajar</option>
                    ${teacherOptions}
                </select>
            </div>
            <div class="flex justify-end pt-4">
                <button type="submit" class="bg-emerald-600 text-white font-bold px-6 py-3 rounded-lg hover:bg-emerald-700 shadow">${siswa ? 'Update Data' : 'Simpan Siswa'}</button>
            </div>
        </form>
    `;
    showModal(siswa ? 'Edit Siswa' : 'Tambah Siswa', modalBody);

    document.getElementById('siswa-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = document.getElementById('siswaId').value;
        const newSiswa = {
            name: document.getElementById('name').value.trim(),
            nisn: document.getElementById('nisn').value.trim(),
            class_reguler_id: parseInt(document.getElementById('classRegulerId').value),
            class_tahfizh_id: parseInt(document.getElementById('classTahfizhId').value),
            teacher_id: parseInt(document.getElementById('teacherId').value)
        };
        if (id) {
            await updateRow('siswa', parseInt(id), newSiswa);
        } else {
            await insertRow('siswa', newSiswa);
        }
        closeModal();
        await loadAllData();
        renderSiswa();
        Toast.fire({ icon: 'success', title: 'Data siswa berhasil disimpan!' });
    }, { once: true });
}

/* ===========================================================
   PENILAIAN
   =========================================================== */
function renderPenilaian() {
    const isTeacherLoggedIn = state.currentUser.role && state.currentUser.role.toLowerCase() === 'guru';
    let teacherOptionsHTML = '';
    let teacherSelectAttributes = 'required';

    if (isTeacherLoggedIn) {
        const loggedInTeacher = state.data.pengajar.find(p => p.id === state.currentUser.linkedId || p.id === state.currentUser.linked_id);
        if (loggedInTeacher) {
            teacherOptionsHTML = `<option value="${loggedInTeacher.id}" selected>${loggedInTeacher.name}</option>`;
            teacherSelectAttributes += ' disabled class="bg-gray-100"';
        }
    } else { // Admin
        teacherOptionsHTML = state.data.pengajar.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
        teacherOptionsHTML = `<option value="">-- Pilih Pengajar --</option>${teacherOptionsHTML}`;
    }

    pageContent.innerHTML = `
        <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
            <div class="lg:col-span-3 bg-white p-6 rounded-2xl shadow-lg">
                <h3 class="text-2xl font-bold mb-6 text-gray-800 border-b pb-4">Form Input Penilaian</h3>
                <form id="penilaian-form" class="space-y-6">
                    <div id="student-search-container">
                        <label for="student-search" class="block text-sm font-semibold text-gray-600 mb-2">Pilih Siswa</label>
                        <div class="relative">
                            <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
                            <input type="text" id="student-search" placeholder="Cari nama siswa..." class="w-full pl-12 pr-4 py-3 text-base border-gray-200 shadow-sm focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-transparent rounded-lg" autocomplete="off">
                            <input type="hidden" id="studentId" name="studentId" required>
                            <div id="student-dropdown" class="absolute z-10 mt-1 w-full bg-white shadow-lg max-h-60 rounded-md py-1 text-base ring-1 ring-black ring-opacity-5 overflow-auto focus:outline-none sm:text-sm hidden"></div>
                        </div>
                    </div>

                    <div>
                        <label for="type" class="block text-sm font-semibold text-gray-600 mb-2">Jenis Penilaian</label>
                        <select id="type" name="type" class="mt-1 block w-full pl-4 pr-10 py-3 text-base border-gray-200 shadow-sm focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-transparent rounded-lg" required>
                            <option value="" selected disabled>Pilih Penilaian</option>
                            <option value="Hafalan">Hafalan Baru</option>
                            <option value="Murojaah">Murojaah (Ulang)</option>
                            <option value="Mengaji">Mengaji (Tilawah)</option>
                            <option value="Iqro">Iqro'</option>
                        </select>
                    </div>

                    <div id="last-assessment-info" class="hidden"></div>
                    <div class="border-t border-gray-200 my-4"></div>
                    <div id="detail-fields" class="space-y-6"></div>

                    <div>
                        <label for="assessedBy" class="block text-sm font-semibold text-gray-600 mb-2">Dinilai Oleh</label>
                        <select id="assessedBy" name="assessedBy" class="mt-1 block w-full pl-4 pr-10 py-3 text-base border-gray-200 rounded-lg" ${teacherSelectAttributes}>
                            ${teacherOptionsHTML}
                        </select>
                    </div>
                    <div class="text-right pt-4">
                        <button type="submit" class="bg-emerald-600 text-white font-bold px-8 py-3 rounded-lg hover:bg-emerald-700 shadow-lg hover:shadow-xl transition-all duration-300"><i class="fas fa-save mr-2"></i> Simpan Penilaian</button>
                    </div>
                </form>
            </div>

            <div class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-lg">
                <h3 class="text-2xl font-bold mb-6 text-gray-800 border-b pb-4">Aktivitas Terbaru</h3>
                <div id="latest-activity-container" class="overflow-y-auto max-h-[60vh]"></div>
            </div>
        </div>
    `;

    const studentSearchInput = document.getElementById('student-search');
    const studentDropdown = document.getElementById('student-dropdown');
    const studentIdInput = document.getElementById('studentId');
    const typeSelect = document.getElementById('type');
    const detailFields = document.getElementById('detail-fields');
    const lastAssessmentInfo = document.getElementById('last-assessment-info');

    const allStudents = state.data.siswa.map(s => {
        const kelasReguler = state.data.kelasReguler.find(k => k.id === (s.class_reguler_id || s.classRegulerId));
        const kelasTahfizh = state.data.kelasTahfizh.find(k => k.id === (s.class_tahfizh_id || s.classTahfizhId));
        const kelasDisplay = `${kelasReguler ? kelasReguler.name : ''}/${kelasTahfizh ? kelasTahfizh.name : ''}`;
        return { id: s.id, name: s.name, display: `${s.name} - ${kelasDisplay}` };
    });

    const renderStudentOptions = (students) => {
        studentDropdown.innerHTML = students.length > 0 ? students.map(s => `<div class="cursor-pointer select-none relative py-2 pl-3 pr-9 hover:bg-emerald-100" data-id="${s.id}" data-display="${s.display}"><span class="font-normal block truncate">${s.display}</span></div>`).join('') : `<div class="px-4 py-2 text-gray-500">Siswa tidak ditemukan.</div>`;
    };

    const attachSurahSearchListeners = () => {
        const surahSearchInput = document.getElementById('surah-search');
        const surahDropdown = document.getElementById('surah-dropdown');
        const surahInput = document.getElementById('surah');
        if (!surahSearchInput) return;
        const renderSurahOptions = (surahs) => {
            surahDropdown.innerHTML = surahs.length > 0 ? surahs.map(s => `<div class="cursor-pointer select-none relative py-2 pl-3 pr-9 hover:bg-emerald-100" data-value="${s}"><span class="font-normal block truncate">${s}</span></div>`).join('') : `<div class="px-4 py-2 text-gray-500">Surah tidak ditemukan.</div>`;
        };
        surahSearchInput.addEventListener('focus', () => { renderSurahOptions(surahList); surahDropdown.classList.remove('hidden'); });
        surahSearchInput.addEventListener('input', () => {
            const filteredSurahs = surahList.filter(s => s.toLowerCase().includes(surahSearchInput.value.toLowerCase()));
            renderSurahOptions(filteredSurahs);
            surahDropdown.classList.remove('hidden');
        });
        surahDropdown.addEventListener('click', (e) => {
            const selectedOption = e.target.closest('div[data-value]');
            if (selectedOption) { surahSearchInput.value = selectedOption.dataset.value; surahInput.value = selectedOption.dataset.value; surahDropdown.classList.add('hidden'); }
        });
    };

    function updateDetailFields() {
        const type = typeSelect.value;
        if (type === 'Iqro') {
            detailFields.innerHTML = `
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="jilid" class="block text-sm font-semibold text-gray-600 mb-2">Jilid</label>
                        <input type="number" name="jilid" id="jilid" class="mt-1 block w-full pl-4 py-3 shadow-sm sm:text-sm border-gray-200 rounded-lg" required>
                    </div>
                    <div>
                        <label for="halaman" class="block text-sm font-semibold text-gray-600 mb-2">Halaman</label>
                        <input type="number" name="halaman" id="halaman" class="mt-1 block w-full pl-4 py-3 shadow-sm sm:text-sm border-gray-200 rounded-lg" required>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="from_baris" class="block text-sm font-semibold text-gray-600 mb-2">Dari Baris</label>
                        <input type="number" name="from_baris" id="from_baris" class="mt-1 block w-full pl-4 py-3 shadow-sm sm:text-sm border-gray-200 rounded-lg" required>
                    </div>
                    <div>
                        <label for="to_baris" class="block text-sm font-semibold text-gray-600 mb-2">Sampai Baris</label>
                        <input type="number" name="to_baris" id="to_baris" class="mt-1 block w-full pl-4 py-3 shadow-sm sm:text-sm border-gray-200 rounded-lg" required>
                    </div>
                </div>`;
        } else if (type) {
            detailFields.innerHTML = `
                <div id="surah-search-container">
                    <label for="surah-search" class="block text-sm font-semibold text-gray-600 mb-2">Surah</label>
                    <div class="relative">
                        <i class="fas fa-book-quran absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
                        <input type="text" id="surah-search" placeholder="Cari nama surah..." class="w-full pl-12 pr-4 py-3 text-base border-gray-200 shadow-sm focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-transparent rounded-lg" autocomplete="off">
                        <input type="hidden" id="surah" name="surah" required>
                        <div id="surah-dropdown" class="absolute z-20 mt-1 w-full bg-white shadow-lg max-h-60 rounded-md py-1 text-base ring-1 ring-black ring-opacity-5 overflow-auto focus:outline-none sm:text-sm hidden"></div>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="from" class="block text-sm font-semibold text-gray-600 mb-2">Dari Ayat</label>
                        <input type="number" name="from" id="from" class="mt-1 block w-full pl-4 py-3 shadow-sm sm:text-sm border-gray-200 rounded-lg" required>
                    </div>
                    <div>
                        <label for="to" class="block text-sm font-semibold text-gray-600 mb-2">Sampai Ayat</label>
                        <input type="number" name="to" id="to" class="mt-1 block w-full pl-4 py-3 shadow-sm sm:text-sm border-gray-200 rounded-lg" required>
                    </div>
                </div>`;
        } else {
            detailFields.innerHTML = '';
        }

        if (type) {
            detailFields.innerHTML += `
                <div>
                    <label for="penilaianStatus" class="block text-sm font-semibold text-gray-600 mb-2">Penilaian</label>
                    <select id="penilaianStatus" name="penilaianStatus" class="mt-1 block w-full pl-4 pr-10 py-3 text-base border-gray-200 shadow-sm rounded-lg" required>
                        <option value="" selected disabled>Pilih Penilaian</option>
                        <option value="Lancar/Pindah">Lancar/Pindah</option>
                        <option value="Kurang Lancar">Kurang Lancar</option>
                        <option value="Mengulang">Mengulang</option>
                    </select>
                </div>`;
        }
        setTimeout(attachSurahSearchListeners, 0);
    }

    function showLastAssessment() {
        const studentId = studentIdInput.value;
        const assessmentType = typeSelect.value;
        lastAssessmentInfo.classList.add('hidden');
        if (!studentId || !assessmentType) return;
        const lastAssessment = [...state.data.penilaian].sort((a,b)=> new Date(b.timestamp)-new Date(a.timestamp)).find(p => p.student_id == studentId && p.type === assessmentType);
        if (lastAssessment) {
            let detailText;
            if (lastAssessment.type === 'Iqro' || (lastAssessment.detail && lastAssessment.detail.jilid)) {
                detailText = `Jilid ${lastAssessment.detail.jilid}, Hal ${lastAssessment.detail.halaman}, Baris ${lastAssessment.detail.from_baris}-${lastAssessment.detail.to_baris}`;
            } else {
                detailText = `${lastAssessment.detail?.surah || '-'} (Ayat ${lastAssessment.detail?.from || '-'}-${lastAssessment.detail?.to || '-'})`;
            }
            const assessor = state.data.pengajar.find(p => p.id === (lastAssessment.assessed_by_id || lastAssessment.assessedById));
            lastAssessmentInfo.innerHTML = `
                <div class="mt-4 p-4 bg-blue-50 border border-blue-200 rounded-lg text-sm space-y-2">
                    <p class="font-semibold text-blue-800"><i class="fas fa-info-circle mr-2"></i>Riwayat Terakhir:</p>
                    <p class="text-blue-700"><span class="font-medium">Detail:</span> ${detailText}</p>
                    <p class="text-blue-700"><span class="font-medium">Status:</span> <span class="font-bold">${lastAssessment.status}</span></p>
                    <p class="text-blue-700"><span class="font-medium">Dinilai oleh:</span> ${assessor ? assessor.name : 'N/A'}</p>
                    <p class="text-xs text-blue-500"><i class="far fa-clock mr-1"></i>${formatTimestamp(lastAssessment.timestamp)}</p>
                </div>`;
            lastAssessmentInfo.classList.remove('hidden');
        } else {
            lastAssessmentInfo.innerHTML = `<div class="mt-4 p-4 bg-gray-100 border border-gray-200 rounded-lg text-sm text-center"><p class="text-gray-600">Belum ada riwayat ${assessmentType} untuk siswa ini.</p></div>`;
            lastAssessmentInfo.classList.remove('hidden');
        }
    }

    studentSearchInput.addEventListener('focus', () => { renderStudentOptions(allStudents); studentDropdown.classList.remove('hidden'); });
    studentSearchInput.addEventListener('input', () => {
        const filteredStudents = allStudents.filter(s => s.name.toLowerCase().includes(studentSearchInput.value.toLowerCase()));
        renderStudentOptions(filteredStudents);
        studentDropdown.classList.remove('hidden');
    });

    studentDropdown.addEventListener('click', (e) => {
        const selectedOption = e.target.closest('div[data-id]');
        if (selectedOption) {
            studentSearchInput.value = selectedOption.dataset.display;
            studentIdInput.value = selectedOption.dataset.id;
            studentDropdown.classList.add('hidden');
            showLastAssessment();
        }
    });

    document.addEventListener('click', (e) => {
        if (!e.target.closest('#student-search-container') && !e.target.closest('#surah-search-container')) {
            studentDropdown.classList.add('hidden');
            const surahDropdown = document.getElementById('surah-dropdown');
            if (surahDropdown) surahDropdown.classList.add('hidden');
        }
    });

    typeSelect.addEventListener('change', () => { showLastAssessment(); updateDetailFields(); });

    document.getElementById('penilaian-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const form = e.target;
        if (!form.studentId.value) { Toast.fire({icon:'warning', title:'Silakan pilih siswa!'}); return; }
        if (!form.penilaianStatus.value) { Toast.fire({icon:'warning', title:'Silakan pilih status penilaian!'}); return; }

        const detail = form.type.value === 'Iqro'
            ? { jilid: form.jilid.value, halaman: form.halaman.value, from_baris: form.from_baris.value, to_baris: form.to_baris.value }
            : { surah: form.surah.value, from: form.from.value, to: form.to.value };

        const newPenilaian = {
            student_id: parseInt(form.studentId.value),
            timestamp: new Date().toISOString(),
            type: form.type.value,
            detail,
            status: form.penilaianStatus.value,
            assessed_by_id: parseInt(form.assessedBy.value)
        };

        await insertRow('penilaian', newPenilaian);
        form.reset();
        studentSearchInput.value = '';
        lastAssessmentInfo.classList.add('hidden');
        updateDetailFields();
        await loadAllData();
        renderLatestActivity('latest-activity-container');
        Toast.fire({icon:'success', title:'Penilaian berhasil disimpan!'});
    });

    updateDetailFields();
    renderLatestActivity('latest-activity-container');
}

/* ===========================================================
   REKAP (simple filter & view) - uses state.data
   =========================================================== */
function renderRekap() {
    const studentOptions = state.data.siswa.map(s => {
        const kelasReguler = state.data.kelasReguler.find(k => k.id === (s.class_reguler_id || s.classRegulerId));
        const kelasTahfizh = state.data.kelasTahfizh.find(k => k.id === (s.class_tahfizh_id || s.classTahfizhId));
        const kelasDisplay = `${kelasReguler ? kelasReguler.name : ''}/${kelasTahfizh ? kelasTahfizh.name : ''}`;
        return `<option value="${s.id}">${s.name} - ${kelasDisplay}</option>`;
    }).join('');
    const teacherOptions = state.data.pengajar.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
    const tahfizhOptions = state.data.kelasTahfizh.map(k => `<option value="${k.id}">${k.name}</option>`).join('');

    pageContent.innerHTML = `
        <div class="bg-white p-6 rounded-lg shadow-md no-print">
            <h3 class="text-xl font-semibold mb-4 text-gray-700">Filter Laporan</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-end">
                <div>
                    <label for="filterStudent" class="block text-sm font-medium text-gray-700">Siswa</label>
                    <select id="filterStudent" class="mt-1 block w-full pl-3 pr-10 py-2 border-gray-300 rounded-md">
                        <option value="">Semua Siswa</option>
                        ${studentOptions}
                    </select>
                </div>
                <div>
                    <label for="filterTeacher" class="block text-sm font-medium text-gray-700">Pengajar</label>
                    <select id="filterTeacher" class="mt-1 block w-full pl-3 pr-10 py-2 border-gray-300 rounded-md">
                        <option value="">Semua Pengajar</option>
                        ${teacherOptions}
                    </select>
                </div>
                <div>
                    <label for="filterTahfizh" class="block text-sm font-medium text-gray-700">Kelas Tahfizh</label>
                    <select id="filterTahfizh" class="mt-1 block w-full pl-3 pr-10 py-2 border-gray-300 rounded-md">
                        <option value="">Semua Kelas</option>
                        ${tahfizhOptions}
                    </select>
                </div>
                <div>
                    <button id="generate-report-btn" class="bg-emerald-600 text-white px-4 py-2 rounded-lg hover:bg-emerald-700 w-full">Tampilkan Laporan</button>
                </div>
            </div>
        </div>
        <div id="report-area" class="mt-6"></div>
    `;

    document.getElementById('generate-report-btn').addEventListener('click', () => {
        const sid = document.getElementById('filterStudent').value;
        const tid = document.getElementById('filterTeacher').value;
        const kid = document.getElementById('filterTahfizh').value;
        // Filter penilaian
        let rows = state.data.penilaian || [];
        if (sid) rows = rows.filter(r => r.student_id == sid);
        if (tid) rows = rows.filter(r => r.assessed_by_id == tid);
        if (kid) {
            const siswaInKelas = state.data.siswa.filter(s => (s.class_tahfizh_id || s.classTahfizhId) == kid).map(s => s.id);
            rows = rows.filter(r => siswaInKelas.includes(r.student_id));
        }
        const reportArea = document.getElementById('report-area');
        if (rows.length === 0) {
            reportArea.innerHTML = `<div class="bg-white p-6 rounded-lg shadow-md">Tidak ada data untuk filter tersebut.</div>`;
            return;
        }
        reportArea.innerHTML = `
            <div class="bg-white p-4 rounded-lg shadow-md">
                <h4 class="font-semibold mb-4">Hasil Laporan (${rows.length} baris)</h4>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="py-2 px-3 text-left text-xs font-medium text-gray-500">Waktu</th>
                                <th class="py-2 px-3 text-left text-xs font-medium text-gray-500">Siswa</th>
                                <th class="py-2 px-3 text-left text-xs font-medium text-gray-500">Jenis</th>
                                <th class="py-2 px-3 text-left text-xs font-medium text-gray-500">Detail</th>
                                <th class="py-2 px-3 text-left text-xs font-medium text-gray-500">Status</th>
                                <th class="py-2 px-3 text-left text-xs font-medium text-gray-500">Dinilai oleh</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${rows.sort((a,b)=> new Date(b.timestamp)-new Date(a.timestamp)).map(r=>{
                                const s = state.data.siswa.find(x=>x.id===r.student_id);
                                const assessor = state.data.pengajar.find(x=>x.id===r.assessed_by_id);
                                let detailText = '';
                                if (r.type === 'Iqro' || (r.detail && r.detail.jilid)) {
                                    detailText = `Jilid ${r.detail.jilid}, Hal ${r.detail.halaman}`;
                                } else {
                                    detailText = `${r.detail?.surah || '-'} ${r.detail?.from || ''}-${r.detail?.to || ''}`;
                                }
                                return `<tr class="border-t"><td class="py-2 px-3 text-xs">${formatTimestamp(r.timestamp)}</td><td class="py-2 px-3">${s? s.name : 'N/A'}</td><td class="py-2 px-3">${r.type}</td><td class="py-2 px-3">${detailText}</td><td class="py-2 px-3">${r.status}</td><td class="py-2 px-3">${assessor?assessor.name:'N/A'}</td></tr>`;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        `;
    });
}

/* ===========================================================
   PENGGUNA (users) management
   =========================================================== */
function renderPengguna() {
    const isAdmin = state.currentUser.role === 'Admin' || (state.currentUser.role && state.currentUser.role.toLowerCase() === 'admin');
    if (!isAdmin) {
        pageContent.innerHTML = `<div class="bg-white p-6 rounded-lg">Akses ditolak.</div>`; return;
    }
    pageContent.innerHTML = `
        <div class="bg-white p-6 rounded-lg shadow-md">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold text-gray-700">Manajemen Pengguna</h3>
                <button id="add-user-btn" class="bg-emerald-600 text-white px-4 py-2 rounded-lg hover:bg-emerald-700"><i class="fas fa-plus mr-2"></i>Tambah Pengguna</button>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full bg-white">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="py-2 px-4 text-left text-xs font-medium text-gray-500 uppercase">Username</th>
                            <th class="py-2 px-4 text-left text-xs font-medium text-gray-500 uppercase">Nama</th>
                            <th class="py-2 px-4 text-left text-xs font-medium text-gray-500 uppercase">Role</th>
                            <th class="py-2 px-4 text-left text-xs font-medium text-gray-500 uppercase">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="users-table-body">
                        ${state.data.users.map(u => `<tr class="border-b"><td class="py-3 px-4">${u.username}</td><td class="py-3 px-4">${u.name || ''}</td><td class="py-3 px-4">${u.role}</td><td class="py-3 px-4 space-x-2"><button class="edit-btn text-blue-500" data-id="${u.id}"><i class="fas fa-edit"></i></button><button class="delete-btn text-red-500" data-id="${u.id}"><i class="fas fa-trash"></i></button></td></tr>`).join('')}
                    </tbody>
                </table>
            </div>
        </div>
    `;

    document.getElementById('add-user-btn').addEventListener('click', () => openUserModal());
    attachCrudEventListeners('users', renderPengguna, openUserModal, 'users');
}

function openUserModal(user = null) {
    // build teacher options for linking if role guru
    const teacherOptions = state.data.pengajar.map(p => `<option value="${p.id}" ${user && user.linked_id == p.id ? 'selected' : ''}>${p.name}</option>`).join('');
    const modalBody = `
        <form id="user-form" class="space-y-4">
            <input type="hidden" id="userId" value="${user ? user.id : ''}">
            <div>
                <label class="block text-gray-700 text-sm font-bold mb-2">Username</label>
                <input id="u-username" class="w-full p-2 border rounded" value="${user? user.username : ''}" required>
            </div>
            <div>
                <label class="block text-gray-700 text-sm font-bold mb-2">Password</label>
                <input id="u-password" class="w-full p-2 border rounded" value="${user? user.password : '123'}" required>
            </div>
            <div>
                <label class="block text-gray-700 text-sm font-bold mb-2">Nama</label>
                <input id="u-name" class="w-full p-2 border rounded" value="${user? user.name : ''}">
            </div>
            <div>
                <label class="block text-gray-700 text-sm font-bold mb-2">Role</label>
                <select id="u-role" class="w-full p-2 border rounded" required>
                    <option value="Admin" ${user && user.role === 'Admin' ? 'selected' : ''}>Admin</option>
                    <option value="Guru" ${user && user.role === 'Guru' ? 'selected' : ''}>Guru</option>
                    <option value="Siswa" ${user && user.role === 'Siswa' ? 'selected' : ''}>Siswa</option>
                </select>
            </div>
            <div id="linked-container" class="${user && user.role === 'Guru' ? '' : 'hidden'}">
                <label class="block text-gray-700 text-sm font-bold mb-2">Link Pengajar (untuk role Guru)</label>
                <select id="u-linkedId" class="w-full p-2 border rounded">
                    <option value="">-- Pilih Pengajar --</option>
                    ${teacherOptions}
                </select>
            </div>
            <div class="flex justify-end">
                <button type="submit" class="bg-emerald-600 text-white px-4 py-2 rounded">${user? 'Update' : 'Simpan'}</button>
            </div>
        </form>
    `;
    showModal(user ? 'Edit Pengguna' : 'Tambah Pengguna', modalBody);

    const roleSelect = document.getElementById('u-role');
    roleSelect.addEventListener('change', () => {
        const lc = document.getElementById('linked-container');
        if (roleSelect.value === 'Guru') lc.classList.remove('hidden'); else lc.classList.add('hidden');
    });

    document.getElementById('user-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = document.getElementById('userId').value;
        const payload = {
            username: document.getElementById('u-username').value.trim(),
            password: document.getElementById('u-password').value.trim(),
            name: document.getElementById('u-name').value.trim(),
            role: document.getElementById('u-role').value,
            linked_id: document.getElementById('u-linkedId')? parseInt(document.getElementById('u-linkedId').value) : null
        };
        if (id) {
            await updateRow('users', parseInt(id), payload);
        } else {
            await insertRow('users', payload);
        }
        closeModal();
        await loadAllData();
        renderPengguna();
        Toast.fire({ icon:'success', title:'Pengguna berhasil disimpan' });
    }, { once: true });
}

/* ===========================================================
   Simple profile & pencapaian pages (siswa)
   =========================================================== */
function renderProfil() {
    // For student role only
    const user = state.currentUser;
    if (!user) { pageContent.innerHTML = '<div class="p-6 bg-white rounded">Silakan login</div>'; return; }
    if (user.role && user.role.toLowerCase() !== 'siswa') { pageContent.innerHTML = '<div class="p-6 bg-white rounded">Hanya untuk siswa</div>'; return; }
    const student = state.data.siswa.find(s => s.nisn === user.username || s.id === user.linked_id || s.id === user.linkedId);
    if (!student) { pageContent.innerHTML = '<div class="p-6 bg-white rounded">Profil siswa tidak ditemukan.</div>'; return; }
    const kelasReguler = state.data.kelasReguler.find(k => k.id === (student.class_reguler_id || student.classRegulerId));
    const kelasTahfizh = state.data.kelasTahfizh.find(k => k.id === (student.class_tahfizh_id || student.classTahfizhId));
    pageContent.innerHTML = `
        <div class="bg-white p-6 rounded-lg shadow-md">
            <h3 class="text-xl font-semibold mb-4">Profil ${student.name}</h3>
            <p><strong>NISN:</strong> ${student.nisn}</p>
            <p><strong>Kelas Reguler:</strong> ${kelasReguler ? kelasReguler.name : '-'}</p>
            <p><strong>Kelas Tahfizh:</strong> ${kelasTahfizh ? kelasTahfizh.name : '-'}</p>
        </div>
    `;
}

function renderPencapaian() {
    const user = state.currentUser;
    if (!user) { pageContent.innerHTML = '<div class="p-6 bg-white rounded">Silakan login</div>'; return; }
    if (user.role && user.role.toLowerCase() !== 'siswa') { pageContent.innerHTML = '<div class="p-6 bg-white rounded">Hanya untuk siswa</div>'; return; }
    const student = state.data.siswa.find(s => s.nisn === user.username || s.id === user.linked_id || s.id === user.linkedId);
    if (!student) { pageContent.innerHTML = '<div class="p-6 bg-white rounded">Profil siswa tidak ditemukan.</div>'; return; }
    const rows = state.data.penilaian.filter(p => p.student_id === student.id);
    pageContent.innerHTML = `
        <div class="bg-white p-6 rounded-lg shadow-md">
            <h3 class="text-xl font-semibold mb-4">Pencapaian ${student.name}</h3>
            <div class="space-y-3">${rows.sort((a,b)=> new Date(b.timestamp)-new Date(a.timestamp)).map(r=>`<div class="p-3 border rounded"><div class="text-sm text-gray-700"><strong>${r.type}</strong> - ${r.status}</div><div class="text-xs text-gray-500">${formatTimestamp(r.timestamp)}</div></div>`).join('')}</div>
        </div>
    `;
}

/* ===========================================================
   Utility: bind some global UI events
   =========================================================== */
function bindGlobalUIEvents() {
    // modal close handled earlier; just ensure clicking backdrop closes
    document.getElementById('modal').addEventListener('click', (e)=> {
        if (e.target.id === 'modal') closeModal();
    });
}

/* ===========================================================
   Initial load: if app is visible, reload data periodically if desired
   =========================================================== */
// Nothing more needed: loadAllData called in initializeApp after login
</script>
</body>
</html>
